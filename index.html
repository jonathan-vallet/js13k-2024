<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>13 steps to death</title><style>body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      body:not(.game) {
        .-game {
          display: none;
        }
      }
      body:not(.editor) {
        .-editor {
          display: none;
        }
      }

      #game {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #gBC {
        position: absolute;
        top: -5%;
        left: -5%;
        width: 110%;
        height: 110%;
        z-index: -1;
        object-fit: cover;
        filter: blur(15px) brightness(50%);
      }</style></head><body oncontextmenu="return!1"><div id="game"><canvas id="gBC"></canvas><canvas id="uiCanvas" class="-game"></canvas><div id="editor" class="-editor"><div id="editorUi"><label>Tile: <select id="eTS"></select></label> <label>Orientation: <select id="eOS"><option value="0">Up</option><option value="1">Right</option><option value="2">Down</option><option value="3">Left</option></select></label> <button id="editorTestLevelButton">Test level</button><p id="editorMessage"></p></div></div><canvas id="gC"></canvas><script>!function(){"use strict";let e=e=>document.querySelector(e),t=(e,t)=>localStorage.setItem(e,t),M=e=>localStorage.getItem(e),r=Math.min,n=Math.max;const l={bG:["#024d53","#599dbc","#72d1c7","#a9ffe6"],crate:["#000","#893a25","#f89e61","#c16c43"],g:["#000","#527f67","#a2ce69","#d6f8e1"],s:["#e5d09e","#cab168"],br:["#000","#811c07","#ca6137","#ffb59c"],silver:["#000","#014a5d","#7ddbff","#d0ffea"],gold:["#000","#5e3718","#d8aa3b","#fdffaa"],p:["#341b2e","#6a5979","#937cb2","#afbeff"]},o={arrow:{r:"16LKZLA\\K^LZLBZLBZLLLLLLLLLLLLG",co:l.bG,limit:0,iS:!0},block:{r:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",co:l.bG,cCO:!0},"block-trigger":{r:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",co:l.g,cCO:!0},boulder:{r:"16LIRHNgqYqNEMgsZrMCMfrYrZsMBMesYqZtMAMfYrYq^qNfZqZuZNerYrYvYN]q[tYNtYs^MAMs[uYMBM\\q[q[MCMtYq\\MENs[NHRE",co:l.crate},crate:{r:"16AXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYO[MZM]OYNYMYNYPYNYMZMYNYMZMYNYPYNYMYNYO]MZM[NAXNA",co:l.crate},flag:{r:"48DYLCYLCYLBZLBZLBZLCMgLMlGMlGMkHMkHMkHMkHMkHMkHMkHMkHMkHMkHMlGMkHMFfGMLCMChHMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLBZLBZLBZK",co:l.br,limit:1},"gong-trigger":{r:"16XQsevesNqfTfqNfOhNgNfNeteNfNfMeqPqeMfMAMeMeqMrMqeMeMBMeMeqPqeMeMBMeNeteNeMBMeMAMhMAMeMBMeMBPBMeMBMeMHMeMBMeMHMeMBMeMAQBMeMBMeMBQAMeMBOHOA",co:[l.br,l.silver,l.gold,l.p],useOrientationForColor:!0,iS:!0},gong:{r:"16F\\JZtZGYfvYEZe^rYC\\jYrYB[lYqYBZnZBYhthYBYgq\\qgYBYgqYrYqgYBYgq\\qgYBZgtgZBeZlZeCeZjZeEe`eGlD",co:[l.br,l.silver,l.gold,l.p],useOrientationForColor:!0},"hole-filled":{r:"16LLLAMANAMFXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYMAM[MZM]MCMAYMYNYNAMLF",co:l.crate},hole:{r:"16LLLYA\\AYGbEYA`AYDdCYAbAYB\\MYNYM\\A\\MYMZMYM\\AZMYMYNYMYMZCZTZCZMYRYMZCZTZEYTYHRLI",co:["#000","#00506e"]},"key-holder":{r:"16LFdCYpYAZ{e\\qbe\\qYeYhYeYe\\qZfZfZe\\qYgZgYe\\qYgYhYe\\qZfZfZe\\qYeYhYeYe\\qbe\\oq[edqZpfYAdZA",co:l.bG,limit:0,iS:!0},key:{r:"16FtKqPqIqMhMqHqMYNeMqHqMYNeMqHqM\\MqIqNYMqJqMeYMqJqNYMqJqMZMqKqNqLArLLLLLK",co:l.g},lock:{r:"16FPKMtMIMq\\qMGMZhYqMEMZeqNYeYqMCNYeqPYeYqMAOYeqPYeYrPYfqNYfYrO[eqNYeYfqMYM\\ereYgMYAYM\\fYgMYCYM[MYgMYEYMYMfYeMYGYMhMYIYPYK\\F",co:l.g},rock:{r:"16FPIOhNFMeresfMDMerYeueMCMfqZesfqMBMgqZgYfMBMiYgZNBNYkZqNBNYiZsMBMqgriqMAMqeqYgqMYgMAMYfqMYeqMYgMAMZeqMYfNYfMAOZNYPYMqBPEOLF",co:l.bG,iS:!0},"spawn-current":{r:"16E\\LBYAYJZBYAYJZAYAYJYAYBYBYD[F[AYAYEZCYBZAZB\\AYB\\BYA\\BZAZBYCZEYAYA[F[DYBYBYAYJYAYAZJYAYBZJYAYLB\\E",co:l.bG,limit:1},spawn:{r:"32E\\L\\LBYAYLAYAYJZBYAYIZBYAYJZAYAYJZAYAYJYAYBYBYGYAYBYBYD[F[AYB[F[AYAYEfCYBYAYErCYBZAZBhAYB[AZBtAYB\\BYAhBZA[BYAtBZAZBYCfEYAYBYCrEYAYA[F[BYA[F[DYBYBYAYGYBYBYAYJYAYAZJYAYAZJYAYBZIYAYBZJYAYLAYAYLB\\L\\E",co:l.bG},trap:{r:"16DNANANGVEQfQCNYM[N[NBMeMfYfMfMeMANZM\\e\\OeMfMYgMfMeO]N]OgNgMeYgN\\eYM]eYOeMeOgYfNAeZN[M[MeBNYeMgMfOCO[fZNFQfMJPF",co:["#306710","#000","#b1712e"]},s:{r:"16ZMYV]MYV]MYW\\MYMYU^MYU^MZU^MZV]MYV]XM\\XM\\X[XN[XM\\X]XZ",co:l.s,limit:0},characters:{r:"144FPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFMlMGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMesereMEMeugMFMlMFMlMEMmMFMlMFMlMEMmMFMlMEMqeveqMEMufNEMqlqMEMereseMEMeugMFMlMFMereseMEMeugMFMlMFMrMrMrMFMqMseMqMFMlMEMqeveqMEMufNEMqlqMDMqeveqMEMufNEMqlqMFMqMrMqMGMqMuMHMjMGMrMrMrMFMqMseMqMFMlMFMrMrMrMFMqMseMqMFMlMFOtOGMtNHOtOFNqMrMqNFMqMuMHNhNGNqMrMqNFMqMuMHNhNFM[P[MGPYMGM[P[MDMZMtMZMFMtNHMZPZMEMZMtMZMFMtOGMZPZMDMZMZrZMZMFN[MFMZM^MZMCOYPYMYqMEQYNFMqM^OCMqYMYPYOFQ[MEO^MqMCMZM^MZMFMYMZMFMZM^MZMCMrM]NqMDMr\\MqMFN]MrMCMqN]MrMEMqNZMYqMEMrM]NEMqTqMGMYMqNGMqTqMEUANEO\\MHUDNAUGN\\MqMFUGN^NHOqMIN^NHMqNZMISHMZNqMIMZNqMJSIMqNZMHMrNrMIMrNJMrNrMJOrMHMrNrMHMrOJMrOJMrNrMJOrMJPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFNjNGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFNjNFMlMEMmMFNjNFMgqhMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMeveMEMerjMFMlMFMgqhMEMmMFMlMFMgqhMEMmMFMlMEMqeveqMEMshMeMDMqlqMEMeveMEMerjMFMlMFMeveMEMerjMFMlMFMeqMrMqeMFMqMqgMqMeMDMgNgMEMqeveqMEMshMeMDMqlqMDMqeveqMEMshMeMDMqlqMFMqMrMqMGMqMqfrMfMEMeMfMeMGMeqMrMqeMFMqMqgMqMeMDMgNgMFMeqMrMqeMFMqMqgMqMeMDMgNgMGNtNHMtNfMFNhNHMqMrMqMGMqMqfrMfMEMeMfMeMHMqMrMqMGMqMqfrMfMEMeMfMeMGMZPZMHSeMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFM[r[MGMYNYMANFMZMfMZMFMYQYNHSfMDMYMgPFNYQYMGTfMDMYNgOEMqN\\NqMFMZMqMHMqNYNYNqMEO\\MrMFMZqNqODMrNeQEMrM\\OGM[MrOEQeNrMCMrN\\NrMFMYMqMGMrN\\NrMCMrM\\PFMsPFPYNYMrMDP\\MrMEMqMZNqMFMrMYNYPDOrNrOGMrNHOrNrOEOqNrMIOYqMIMrNqOGMrNqOGMrNYNGOqNrMIMqNqMKMqMLMqNqMKOqMJMqNqMJMqOKMqOJMqOqMKOqME",co:["#000","#e42c37","#c07548","#fdcbb0"],limit:0},spikes:{r:"16LEpeBe|qeA|sArgqgqgrAreMeqeMeqeMerArgqgqgrA|sArgqgqgrAreMeqeMeqeMerArgqgqgrA|sArgqgqgrAreMeqeMeqeMerArgqgqgrB|qB",co:l.bG},"switch-off":{r:"16LLIpfBedeBeZxZeBeYzYeBeYs\\sYeBeYs\\sYeBeYs\\sYeBeYzYeBeYzYeBeZxZeBedeBpfLLI",co:[l.p,l.br,l.silver,l.gold],useOrientationForColor:!0},"switch-on":{r:"16CVEMexeMDMqftfqMCeMqeqPqeqMeBeMqeqPqeqMeBeMqeqPqeqMeBeMqftfqMeBeMexeMeBeNlNeBeMqZereZqMeBeMeqZfZqeMeBeMYerfreYMeBeNYe\\eYNeBeXeBiDiLE",co:l.p,co:[l.p,l.br,l.silver,l.gold],useOrientationForColor:!0},"switch-trigger":{r:"16Zp[pfYplTkMxMjMxMjMrPrMjMrPrMjMrPrMjMxMjMxMjM`MjYTYk`hYpf[pZ",co:l.p,co:[l.p,l.br,l.silver,l.gold],useOrientationForColor:!0}},i=16,a=13,c=20,s=10,N={flag:200,spawn:600},Y=225,f=125,q=300,u=400,h=0,g=1,d=2,Z=3,A=[];["","-6N-F-N-13N-3N-7N7Bz2CzMN7-2GAz-N2-6NLN-2N4-2N-6NHN-6E2-17A-2O","-2N-3N5-9N-E-J-MCxBx2By-7N-3N5-By-7N-N-N5-N-5N3-E-P-2JE-N-5LJ2-E-N5-N-5N11HN-2F-2G-5Q5ON","-6NGN-5EQN2-6N-N-5N-N2-4F-M-M-2O-2Cz-CzL-6N-N-2E-2N-NQ-6N5CN3-NQ-8N-7NQ-8N3JN5Q-8NL-4HQ2P","-7Bz8N-9NEN5CN-6O-2Q-Q-4H-6E-3Q-Q-5P-5W-3NTN7MN-7V-2WN-6N3VN4UN3-3F-2N3GN4L-N2","-BxByBxGxNGy-4N-L-N-3CBxBVM-5N2HN2-2NMNQN9QN4GCQO-9PQHy-FN-NQN6WN2QN5-NVN-4N-4N5-3N-4N-2E-HxLN7-4N-4N4","G-T6-DOH-2UxM-FN10-ND-N4-4N6-E-2N-7NWzVxHyEWx-E-2N-4D-2N2PNPN-N-2N-3N2-E-2EN3-N-2N-3LUz-7NHxN-TV-2GyWzT2JTJ-3NWNTGxT-N2"].forEach((e=>{const t=R(e);A.push(t)}));const E={1:"010110010010111",2:"01101001001001001111",3:"11100001001100011110",4:"00110101100111110001",5:"11111000111100011110",6:"01101000111010010110",7:"11110001001000100010",8:"01101001011010010110",9:"01101001011100010110",0:"01101001100110010110",A:"01101001111110011001",C:"011100100100011",D:"110101101101110",E:"111100111100111",G:"01111000101110010110",I:"111010010010111",L:"100100100100111",M:"1000111011101011000110001",N:"10011101101110011001",O:"01101001100110010110",P:"11101001111010001000",R:"11101001111010101001",S:"01111000011000011110",T:"111010010010010",U:"10011001100110010110",V:"1000110001010100101000100",W:"1010110101101010101001010"," ":"000000000000000",":":"000010000010000",x:"000000101010101"};function L(e){let t=0;for(let M=0;M<e.text.length;M++){const r=e.text.charAt(M),n=E[r],l=n.length/5;for(let r=0;r<5;r++)for(let o=0;o<l;o++){"1"===n[r*l+o]&&e.ctx.rect((e.x+(o+t+e.hspacing*M))*y,(e.y+r)*y,y,y)}t+=l}}function F(e){const t={ctx:b,x:0,y:0,text:"",vspacing:1,hspacing:1,color:"#fff",...e},M=t.text.split("\n"),r=5*y;t.ctx.beginPath();for(let e=0;e<M.length;e++){const n=M[e],l=t.x,o=t.y+(r+t.vspacing*y)*e;L({ctx:t.ctx,x:l,y:o,text:n,hspacing:t.hspacing})}t.ctx.fillStyle=t.color,t.ctx.fill()}const p=e("#uiCanvas"),B=p.getContext("2d"),x=e("#gC"),b=x.getContext("2d"),w=e("#gBC"),m=w.getContext("2d");let C,O="menu",y=1,k=0,v=0;const D=[];let G=1,H=e("#eTS"),P=e("#eOS"),J={x:-1,y:-1},I=(...e)=>Q(S(...e)),Q=(...e)=>{let t=j.createBufferSource(),M=j.createBuffer(e.length,e[0].length,T);return e.map(((e,t)=>M.getChannelData(t).set(e))),t.buffer=M,t.connect(j.destination),t.start(),t},S=(e=1,t=.05,M=220,l=0,o=0,i=.1,a=0,c=1,s=0,N=0,Y=0,f=0,q=0,u=0,h=0,g=0,d=0,Z=1,A=0,E=0)=>{let L,F,p=2*Math.PI,B=s*=500*p/T**2,x=(0<h?1:-1)*p/4,b=M*=(1+2*t*Math.random()-t)*p/T,w=[],m=0,C=0,O=0,y=1,k=0,v=0,D=0;for(N*=500*p/T**3,h*=p/T,Y*=p/T,f*=T,q=T*q|0,F=(l=99+T*l)+(A*=T)+(o*=T)+(i*=T)+(d*=T)|0;O<F;w[O++]=D)++v%(100*g|0)||(D=a?1<a?2<a?3<a?Math.sin((m%p)**3):n(r(Math.tan(m),1),-1):1-(2*m/p%2+2)%2:1-4*Math.abs(Math.round(m/p)-m/p):Math.sin(m),D=(q?1-E+E*Math.sin(2*Math.PI*O/q):1)*(0<D?1:-1)*Math.abs(D)**c*e*z*(O<l?O/l:O<l+A?1-(O-l)/A*(1-Z):O<l+A+o?Z:O<F-d?(F-O-d)/i*Z:0),D=d?D/2+(d>O?0:(O<F-d?1:(F-O)/d)*w[O-d|0]/2):D),L=(M+=s+=N)*Math.sin(C*h-x),m+=L-L*u*(1-1e9*(Math.sin(O)+1)%2),C+=L-L*u*(1-1e9*(Math.sin(O)**2+1)%2),y&&++y>f&&(M+=Y,b+=Y,y=0),!q||++k%q||(M=b,s=B,y=y||1);return w},z=.3,T=44100,j=new(window.AudioContext||webkitAudioContext),X=[];function K(e){const t=function(e){const t="A".charCodeAt(0),M=[],r=parseInt(e.match(/^\d+/)[0],10);e=e.replace(/^\d+/,"");for(let r=0;r<e.length;++r){const n=e[r].charCodeAt(0)-t,l=Math.floor(n/12),o=n%12+1;M.push(...Array(o).fill(l))}return{pixels:M,imageWidth:r}}(o[e].r);X=t.pixels;const M=function(e,t){const M=[];for(let r=0;r<e.length;r+=t)M.push(e.slice(r,r+t));return M}(t.pixels,t.imageWidth),r=function(e,t,M){const r=[],n=e.length,l=e[0].length;for(let o=0;o<n;o+=M)for(let n=0;n<l;n+=t){const l=[];for(let r=0;r<M;r++)l.push(e[o+r].slice(n,n+t));r.push(l)}return r}(M,16,16);return r}function R(e){const t=[];let M=0,r=0,n=0;const l=/([A-Z\-])([xyz]?)(\d*)/g;let o;for(;null!==(o=l.exec(e));){const e=o[1],l=o[2]||"",i=parseInt(o[3]||"1",10),a="-"===e?null:U(e),s=V(l);for(let e=0;e<i;e++){let e=n%(c-2)+1,l=Math.floor(n/(c-2))+1;a&&(t.push({tile:a,x:e,y:l,o:s}),"spawn-current"===a&&(M=e,r=l)),++n}}for(let e=0;e<t.length;e++){const M=t[e];["crate","boulder"].includes(M.tile)&&(t.splice(e,1),t.push(M))}return{characterInitialX:M,characterInitialY:r,levelData:t}}function V(e){switch(e){case"x":return 1;case"y":return 2;case"z":return 3;default:return 0}}function U(e){return Object.keys(o)[e.charCodeAt(0)-"A".charCodeAt(0)]}function W(e){let t="",M="",r="",n=0;for(let e=1;e<=s-2;e++)for(let l=1;l<=c-2;l++){const o=ie(l,e),i=$(o?.tile),a=_(o?.o);i===M&&a===r?++n:(t+=M+r,n>1&&(t+=`${n}`),M=i,r=a,n=1)}return t+=M+r,n>1&&(t+=`${n}`),t=t.replace(/-[0-9]+$/,""),t}function U(e){return Object.keys(o)[e.charCodeAt(0)-"A".charCodeAt(0)]}function $(e){if(!e)return"-";const t=Object.keys(o).indexOf(e);return String.fromCharCode("A".charCodeAt(0)+t)}function _(e){return{1:"x",2:"y",3:"z"}[e]||""}function ee(){b.clearRect(0,0,x.width,x.height),"menu"===O&&function(){st+=.005*Nt,(st>.9||st<.6)&&(Nt*=-1);const e="#1c0066",t="#01399a",M="#0090cc";ht(m,x.width,0,x.height/2.5,e,t,st),ht(m,x.width,x.height/2.5,x.height/2,t,M,st/2),b.drawImage(w,0,0,x.width,x.height);const r=5,n=15,l=4;Yt=[],at.forEach(((e,t)=>{const M=n+t*l,o=t===ct;F({ctx:b,x:r*y,y:M*y,scale:2,text:e.text,color:o?"#ff0":e.isDisabled?"#999":"#000"}),Yt.push({x:r-2,y:(M-6)*y,width:80*y,height:16*y,action:e.action,isDisabled:e.isDisabled})}))}(),"editor"===O&&(te(G),Mt()),"game"===O&&(te(G),function(){B.fillStyle="#333",B.fillRect(0,0,p.width,p.height),F({ctx:B,x:10,y:7,text:"STEPS:"});let e=0,t=0;if(Xe>=10){const M=Xe-9;e=ue(M),t=ue(M)}F({ctx:B,x:40+e,y:7+t,text:`${Xe}`,color:he(Xe)});const M=o.key.tiles[0],r=o.key.co||["#000","#f00","#0f0","#00f"];ne(M,r,4.5,.2,{context:B}),F({ctx:B,x:120,y:7,text:`LEVEL: ${G}`}),F({ctx:B,x:90,y:7,text:`x${k}`}),F({ctx:B,x:270,y:3,text:"E: UNDO"}),F({ctx:B,x:270,y:10,text:"R: RESET"})}(),function(){const e=o.characters.tiles[ve],t=o.characters.co;ne(e,t,Be,xe,{scale:Ee,flipHorizontally:Le===g})}())}function te(e){b.drawImage(w,0,0,x.width,x.height),re(A[e].levelData)}function Me(e,t){const M=o[e].tiles[0],r=o[e].co,n=o[t].tiles[0],l=o[t].co;for(let e=0;e<s;e++)for(let t=0;t<c;t++)ne(M,r,t,e),0!==t&&t!==c-1&&0!==e&&e!==s-1||ne(n,l,t,e);"game"===O&&re(A[G].levelData,!0),m.drawImage(x,0,0,w.width,w.height)}function re(e,t=!1){e.forEach((e=>{const M=o[e.tile];if(t&&"key"===e.tile){const t=o["key-holder"];ne(t.tiles[0],t.co,e.x,e.y)}if("game"===O&&(t&&!M.iS||!t&&M.iS))return;ne(M.tiles[e.animationFrame||0],e.color||o[e.tile].co,e.x,e.y,{o:e.o||h,scale:e.scale||1,useOrientationForColor:o[e.tile].useOrientationForColor})}))}function ne(e,t,M,r,n={}){const{o:l=h,scale:o=e.scale||1,context:a=b,flipHorizontally:c=!1,alpha:s=1,useOrientationForColor:N=!1}=n;a.save();const Y=i*y/2;a.translate(Math.floor((M+.5)*i*y),Math.floor((r+.5)*i*y));let f=1;c&&(f=-1),a.scale(o*f,o),N?t=t[l]:a.rotate(l*Math.PI/2),a.translate(-Y,-Y);for(let M=0;M<e.length;M++)for(let r=0;r<e[M].length;r++){const n=e[M][r];n>0&&(a.fillStyle=t[n-1],a.globalAlpha=s,a.fillRect(r*y,M*y,y,y))}a.restore()}function le(e){G=e,Me("s","rock"),A[G].initialData=JSON.parse(JSON.stringify(A[G].levelData)),Xe=0,k=0,C=[],Fe=A[G].characterInitialX,pe=A[G].characterInitialY,Be=Fe,xe=pe,Ve(d),Ee=1}function oe(e,t){return e>=1&&e<c-1&&t>=1&&t<s-1}function ie(e,t,M=[],r=G){let n=null,l=A[r].levelData;for(const r of l)r.x===e&&r.y===t&&(M.length>0?M.includes(r.tile)&&(n=r):n=r);return n}function ae(e=[],t=G){let M=[],r=A[t].levelData;for(const t of r)e.length>0?e.includes(t.tile)&&M.push(t):M.push(t);return M}function ce(e,t,M){A[G].levelData=A[G].levelData.filter((r=>r.tile!==e||r.x!==t||r.y!==M))}function se(e,t,M,r={}){A[G].levelData[r.isUnder?"unshift":"push"]({tile:e,x:t,y:M,...r})}function Ne(e,t,M){we=e,ge=e.x,de=e.y,Ze=t,Ae=M,me=0}function Ye(e,t,M,r){fe("block-trigger",e,t),fe("block",e,t),et("block");const n=e+M,l=t+r,o=ie(n,l)?.tile;if("block"===o){const e=A[G].levelData.find((e=>e.x===n&&e.y===l&&"block"===e.tile));if(e){const t=e.o||h;let M=0,r=0;t===Z?M=-1:t===g?M=1:t===h?r=-1:t===d&&(r=1),setTimeout((()=>{Ye(n,l,M,r)}),120)}}}function fe(e,t=null,M=null,r=null,n=()=>{},l=Y){A[G].levelData.filter((n=>!(n.tile!==e||null!==t&&n.x!==t||null!==M&&n.y!==M||null!==r&&n.o!==r))).forEach((e=>{e.isBeingRemoved=!0,e.scale=1,e.elapsed=0,e.removalDuration=l,e.removeCallback=n}))}function qe(e){let t=ae("switch-on"),M=ae("switch-off");t.forEach((t=>{t.o===e&&(t.tile="switch-off")})),M.forEach((t=>{if(t.o===e){t.tile="switch-on";let e=ie(t.x,t.y,["crate","boulder"]);e&&fe(e.tile,t.x,t.y)}}))}function ue(e){const t=.5*e;return Math.random()*t-t/2}function he(e){return e<11?"rgb(255, 255, 255)":e<12?"rgb(255, 255, 0)":e<13?"rgb(255, 165, 0)":"rgb(255, 0, 0)"}!function(){for(const e in o)o[e].tiles=K(e)}();let ge,de,Ze,Ae,Ee,Le,Fe,pe,Be,xe,be,we=null,me=0;function Ce(e,t,M,r,n){let l=!1;switch(n?.tile){case"crate":case"boulder":if(function(e,t,M,r,n){let l=1;"boulder"===e&&(l=c);let o=0;for(;o<l;){let e=t+(o+1)*r,l=M+(o+1)*n,i=ie(e,l)?.tile||null;if(!oe(e,l)||null!==i&&!["arrow","hole","trap","hole-filled","switch-off","switch-trigger","spikes"].includes(i))break;o++}if(o>0){let l=A[G].levelData;for(const i of l)if(i.x===t&&i.y===M&&i.tile===e){Ne(i,t+o*r,M+o*n);for(let t=1;t<o;t++)setTimeout((()=>{et(e)}),f*t);return!0}}return!1}(n?.tile,e,t,M,r)){l=!0,Oe();let M=ie(e,t,["switch-trigger"]);M&&qe(M.o)}break;case"lock":k>0&&(l=!0,Oe(),fe("lock",e,t,null,(()=>{k--})));break;case"trap":Oe();break;case"block-trigger":const o=n.o||h;(o===Z&&-1===M||o===g&&1===M||o===h&&-1===r||o===d&&1===r)&&(l=!0,Oe(),Ye(e,t,M,r));break;case"gong-trigger":n.triggered||(l=!0,Oe(),n.triggered=!0,fe("gong",null,null,n.o))}return l}function Oe(){C.push({levelData:JSON.parse(JSON.stringify(A[G].levelData)),stepsPerformed:Xe,collectedKeysNumber:k,characterX:Be,characterY:xe,characterDirection:Le})}function ye(e){if(e){const t=D.indexOf(e);-1!==t&&D.splice(t,1)}"r"===e&&(A[G].levelData=JSON.parse(JSON.stringify(A[G].initialData)),le(G)),"e"===e&&function(){if(C.length>0){const e=C.pop();A[G].levelData=e.levelData,Xe=e.stepsPerformed,k=e.collectedKeysNumber,Be=e.characterX,xe=e.characterY,Ve(e.characterDirection)}}(),_e=!1}function ke(e){switch(e){case"ArrowUp":case"z":case"w":return"up";case"ArrowDown":case"s":return"down";case"ArrowLeft":case"q":case"a":return"left";case"ArrowRight":case"d":return"right";default:return e}}let ve,De,Ge,He,Pe,Je,Ie,Qe,Se=Be,ze=xe,Te=Be,je=xe,Xe=0;function Ke(e,t,M){if(Ge||be||we)return;const n=Be+e,l=xe+t;Ve(M),function(e,t,M=0,r=0){if(we||be||Ge)return!1;if(!oe(e,t))return et("wall"),!1;const n=ie(e,t),l=n?.tile||null;if(n&&n.isBeingRemoved)return!1;W(A[G].levelData);let o=Ce(e,t,M,r,n);return o&&et(l),!![null,"arrow","key","key-holder","flag","trap","hole","spikes","hole-filled","spawn","spawn-current","switch-trigger","switch-off"].includes(l)||(o?(++Xe,_e=!0,We(Be,xe,o)):et("wall"),!1)}(n,l,e,t)&&(Xe<a&&(be=!0,Se=Be,ze=xe,Te=n,je=l,De=0),Xe=r(Xe+1,a))}function Re(e=null,t=null){Ge=!0,Pe=Be,Je=xe,Ie=e||Fe,Qe=t||pe,He=performance.now()}function Ve(e){Le=e,ve=Ue(Le)}function Ue(e){switch(e){case h:return 2;case g:case Z:return 1;case d:return 0}}function We(e,M,r){const n=ie(e,M,["trap","switch-trigger"]),l=ie(Be,xe);switch(n?.tile){case"trap":r||"hole"===l?.tile||(et("trap"),n.tile="hole");break;case"switch-trigger":qe(n.o)}switch(l?.tile){case"hole":case"spikes":Re(e,M),--Xe;break;case"flag":return t("currentLevel",G+1),le(G+1),!1;case"spawn-current":Xe=0;break;case"spawn":ie(Fe,pe).tile="spawn",l.tile="spawn-current",l.animationFrame=0,l.elapsed=0,Fe=Be,pe=xe,Xe=0;break;case"switch-trigger":qe(l.o);break;case"key":ce("key",Be,xe),et("key"),++k}Xe>=a&&(Re(),setTimeout((()=>{Xe=0}),u))}function $e(e){!function(e){if(A[G].levelData.forEach((t=>{if(o[t.tile].tiles.length>1){t.elapsed=(t.elapsed||0)+e;const M=N[t.tile];t.elapsed>=M&&(t.animationFrame=(t.animationFrame+1)%o[t.tile].tiles.length||0,t.elapsed=0)}if(t.isBeingRemoved){t.elapsed=(t.elapsed||0)+e;const M=t.removalDuration||Y;t.scale=n(1-t.elapsed/M,0),t.scale<=0&&(ce(t.tile,t.x,t.y),t.removeCallback&&t.removeCallback())}})),!be&&!Ge&&D.length>0){switch(D[D.length-1]){case"up":Ke(0,-1,h);break;case"down":Ke(0,1,d);break;case"left":Ke(-1,0,Z);break;case"right":Ke(1,0,g)}}be&&function(e){De+=e;const t=r(De/q,1);Be=Se+(Te-Se)*t,xe=ze+(je-ze)*t;let M=Ue(Le);switch(Math.floor(3*t)){case 0:ve=M+3;break;case 1:ve=M;break;case 2:ve=M+6}t>=1&&(be=!1,Be=Te,xe=je,De=0,ve=M,We(Se,ze))}(e);we&&function(e){me+=e;const t=Math.abs(ge-Ze)+Math.abs(de-Ae);const M=r(me/(f*t),1);if("boulder"===we.tile){const e=4,r=t*e,n=Math.floor(M*r)%e;we.o=n}if(we.x=ge+(Ze-ge)*M,we.y=de+(Ae-de)*M,M>=1){if(we.x=Ze,we.y=Ae,me=0,"crate"===we.tile&&function(e){const t=ie(e.x,e.y,["hole","trap"]);t&&(ce(t.tile,e.x,e.y),ce("crate",e.x,e.y),se("hole-filled",e.x,e.y,{isUnder:!0}),et("fall"))}(we),["crate","boulder"].includes(we.tile)){let e=ie(Ze,Ae,["switch-trigger"]);e&&qe(e.o)}if("boulder"===we.tile){const e=Ze-ge,t=Ae-de,M=ie(we.x+(0!==e?Math.sign(e):0),we.y+(0!==t?Math.sign(t):0));M&&"gong-trigger"===M.tile&&!M.triggered&&(M.triggered=!0,Oe(),fe("gong",null,null,M.o),et("gong-trigger"))}we=null}}(e)}(e-v),Ge&&function(){const e=performance.now()-He,t=r(e/u,1);t<.5?(Ee=1-2*t,Be=Pe,xe=Je):(Ee=2*(t-.5),Be=Ie,xe=Qe,Ie===Fe&&Qe===pe&&Ve(d));t>=1&&(Ge=!1,Be=Ie,xe=Qe,Ee=1)}(),ee(),v=e,requestAnimationFrame($e)}addEventListener("keydown",(e=>{const t=ke(e.key);"game"===O&&function(e){e&&!D.includes(e)&&D.push(e)}(t),"menu"===O&&function(e,t){switch(e){case"up":ct=(ct-1+at.length)%at.length,at[ct].isDisabled&&(ct=(ct-1+at.length)%at.length);break;case"down":ct=(ct+1)%at.length,at[ct].isDisabled&&(ct=(ct+1)%at.length)}if("Enter"===t.key){const e=at[ct];e.isDisabled||ft(e.action)}}(t,e),"Escape"===e.key&&ot("menu")})),addEventListener("keyup",(e=>{const t=ke(e.key);"game"===O&&ye(t)})),x.addEventListener("mousemove",(e=>{e.preventDefault();const t=x.getBoundingClientRect(),M=e.clientX-t.left,r=e.clientY-t.top;"menu"===O&&Yt.forEach(((e,t)=>{M>=e.x&&M<=e.x+e.width&&r>=e.y&&r<=e.y+e.height&&(e.isDisabled||(ct=t))})),"editor"===O&&(J.x=Math.floor(M/(i*y)),J.y=Math.floor(r/(i*y)),Mt(),tt&&rt(e))})),x.addEventListener("mouseleave",(e=>{e.preventDefault(),"editor"===O&&(J.x=-1,J.y=-1,Mt())})),x.addEventListener("mousewheel",(e=>{if(e.preventDefault(),"editor"===O){const t=n(-1,r(1,e.wheelDelta||-e.detail));P.value=(parseInt(P.value)+t+4)%4,Mt()}})),x.addEventListener("mousedown",(e=>{tt=!0,"editor"===O&&rt(e)})),x.addEventListener("click",(e=>{"menu"===O&&function(e){const t=x.getBoundingClientRect(),M=e.clientX-t.left,r=e.clientY-t.top;Yt.forEach((e=>{M>=e.x&&M<=e.x+e.width&&r>=e.y&&r<=e.y+e.height&&(e.isDisabled||ft(e.action))}))}(e)})),window.addEventListener("mouseup",(e=>{tt=!1}));let _e=!1;function et(e){switch(e){case"gong-trigger":I(...[,0,523.2511,.02,,1.5,1,.5,-.05,.5,,,.3,.05,,,.05,.8,,.05]);break;case"block":I(...[,0,146.8324,.1,,0,,,,,,,,4,,,,0,.2]);break;case"boulder":I(...[,0,73.41619,.1,,0,,,,,,,,4,,,,0,.2]);break;case"crate":I(...[,0,146.8324,.05,,.05,,1.3,,,,,,3]);break;case"key":I(...[,0,1320,,.06,.3,1,,,,880,.06]);break;case"lock":I(...[,0,440,.1,,,1,.3,,,-110,.15,,,,,,,.1]);break;case"trap":I(...[.5,0,440,.08,,.2,4,2,,,,,,5]);break;case"wall":_e||(_e=!0,I(...[,0,440,.15,.01,.12,1,1.59,-6.98,4.97]))}}let tt=!1;function Mt(){const e=H.value,t=parseInt(P.value);ne(o[e].tiles[0],o[e].co,J.x,J.y,{o:o[e].cCO||o[e].useOrientationForColor?t:h,useOrientationForColor:o[e].useOrientationForColor,scale:1,flipHorizontally:!1,alpha:.5})}function rt(e){if(1===e.buttons){if(!ie(J.x,J.y)&&oe(J.x,J.y)){se(H.value,J.x,J.y,{o:o[H.value].cCO||o[H.value].useOrientationForColor?parseInt(P.value):h});W(A[G].levelData)}}else if(2===e.buttons){let e=ie(J.x,J.y);e&&(ce(e.tile,J.x,J.y),W(A[G].levelData))}}e("#editorTestLevelButton").addEventListener("click",(()=>{if(!function(){let e=A[G].levelData,t=0,M=0;e.forEach((e=>{"spawn-current"===e.tile?t++:"flag"===e.tile&&M++}));let r="",n=1===t&&1===M;n||(1!==t&&(r+="There must be exactly one player spawn point.\n"),1!==M&&(r+="There must be exactly one flag.\n"));return nt.textContent=r,n}())return;let e=W(A[G].levelData);window.open(`./index.html?level=${e}`)}));let nt=e("#editorMessage");function lt(){y=Math.min(Math.floor(window.innerWidth/(c*i)),Math.floor(.89*window.innerHeight/(s*i))),x.width=c*i*y,x.height=s*i*y,p.width=x.width,p.height=1.1*i*y,window.innerWidth/window.innerHeight>c/s?(w.width=window.innerWidth,w.height=window.innerWidth*(s/c)):(w.height=window.innerHeight,w.width=window.innerHeight*(c/s))}function ot(e){document.body.classList.remove(O),document.body.classList.add(e),O=e,"game"===O&&le(G),"editor"===O&&(G=0,le(G),Object.keys(o).forEach((e=>{if(0!==o[e].limit){let t=document.createElement("option");t.value=e,t.text=e,H.appendChild(t)}})))}window.addEventListener("resize",(()=>{lt(),Me("s","rock")})),function(){b.imageSmoothingEnabled=!1,lt();const e=new URLSearchParams(window.location.search).get("level");if(e){let t=R(e);t&&(A.push(t),G=A.length-1,ot("game"))}else ot(O);requestAnimationFrame($e)}();let it=null!==M("currentLevel");const at=[{text:"CONTINUE",action:"continue",isDisabled:!it},{text:"NEW GAME",action:"newGame",isDisabled:!1},{text:"LEVEL EDITOR",action:"levelEditor",isDisabled:!1}];let ct=it?0:1,st=.6,Nt=1,Yt=[];function ft(e){switch(e){case"continue":G=parseInt(M("currentLevel")),ot("game");break;case"newGame":ot("game");break;case"levelEditor":ot("editor")}}const qt=[[-.5,0,-.375,.125],[.25,-.25,.375,-.125],[-.3125,.1875,-.4375,.0625],[.4375,-.0625,.3125,-.1875]],ut=4;function ht(e,t,M,r,n,l,o=.25){for(let i=0;i<r;i++){const a=i*y/r;for(let r=0;r<t;r++){const t=a+qt[i%ut][r%ut]*o<.5?n:l;e.fillStyle=t,e.fillRect(r*y,M+i*y,y,y)}}}}();</script></div></body></html>