<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>13 steps to death</title><style>body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      #game {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #gameBackgroundCanvas {
        position: absolute;
        top: -5%;
        left: -5%;
        width: 110%;
        height: 110%;
        z-index: -1; /* Behind the main canvas */
        object-fit: cover;
        filter: blur(15px) brightness(50%); /* Apply blur and darken the background */
      }</style></head><body style="overflow: hidden"><div id="game"><canvas id="gameBackgroundCanvas"></canvas><canvas id="uiCanvas"></canvas><canvas id="gameCanvas"></canvas></div><script>"use strict";const IMAGE_LIST={arrow:"16LKZLA\\K^LZLBZLBZLLLLLLLLLLLLG",block:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",characters:"144FPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFMlMGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMesereMEMeugMFMlMFMlMEMmMFMlMFMlMEMmMFMlMEMqeveqMEMufNEMqlqMEMereseMEMeugMFMlMFMereseMEMeugMFMlMFMrMrMrMFMqMseMqMFMlMEMqeveqMEMufNEMqlqMDMqeveqMEMufNEMqlqMFMqMrMqMGMqMuMHMjMGMrMrMrMFMqMseMqMFMlMFMrMrMrMFMqMseMqMFMlMFOtOGMtNHOtOFNqMrMqNFMqMuMHNhNGNqMrMqNFMqMuMHNhNFM[P[MGPYMGM[P[MDMZMtMZMFMtNHMZPZMEMZMtMZMFMtOGMZPZMDMZMZrZMZMFN[MFMZM^MZMCOYPYMYqMEQYNFMqM^OCMqYMYPYOFQ[MEO^MqMCMZM^MZMFMYMZMFMZM^MZMCMrM]NqMDMr\\MqMFN]MrMCMqN]MrMEMqNZMYqMEMrM]NEMqTqMGMYMqNGMqTqMEUANEO\\MHUDNAUGN\\MqMFUGN^NHOqMIN^NHMqNZMISHMZNqMIMZNqMJSIMqNZMHMrNrMIMrNJMrNrMJOrMHMrNrMHMrOJMrOJMrNrMJOrMJPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFNjNGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFNjNFMlMEMmMFNjNFMgqhMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMeveMEMerjMFMlMFMgqhMEMmMFMlMFMgqhMEMmMFMlMEMqeveqMEMshMeMDMqlqMEMeveMEMerjMFMlMFMeveMEMerjMFMlMFMeqMrMqeMFMqMqgMqMeMDMgNgMEMqeveqMEMshMeMDMqlqMDMqeveqMEMshMeMDMqlqMFMqMrMqMGMqMqfrMfMEMeMfMeMGMeqMrMqeMFMqMqgMqMeMDMgNgMFMeqMrMqeMFMqMqgMqMeMDMgNgMGNtNHMtNfMFNhNHMqMrMqMGMqMqfrMfMEMeMfMeMHMqMrMqMGMqMqfrMfMEMeMfMeMGMZPZMHSeMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFM[r[MGMYNYMANFMZMfMZMFMYQYNHSfMDMYMgPFNYQYMGTfMDMYNgOEMqN\\NqMFMZMqMHMqNYNYNqMEO\\MrMFMZqNqODMrNeQEMrM\\OGM[MrOEQeNrMCMrN\\NrMFMYMqMGMrN\\NrMCMrM\\PFMsPFPYNYMrMDP\\MrMEMqMZNqMFMrMYNYPDOrNrOGMrNHOrNrOEOqNrMIOYqMIMrNqOGMrNqOGMrNYNGOqNrMIMqNqMKMqMLMqNqMKOqMJMqNqMJMqOKMqOJMqOqMKOqME",crate:"16AXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYO[MZM]OYNYMYNYPYNYMZMYNYMZMYNYPYNYMYNYO]MZM[NAXNA",flag:"48DYLCYLCYLBZLBZLBZLCMgLMlGMlGMkHMkHMkHMkHMkHMkHMkHMkHMkHMkHMlGMkHMFfGMLCMChHMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLBZLBZLBZK","gong-trigger":"16XQsevesNqfTfqNfOhNgNfNeteNfNfMeqPqeMfMAMeMeqMrMqeMeMBMeMeqPqeMeMBMeNeteNeMBMeMAMhMAMeMBMeMBPBMeMBMeMHMeMBMeMHMeMBMeMAQBMeMBMeMBQAMeMBOHOA",gong:"16F\\JZtZGYfvYEZe^rYC\\jYrYB[lYqYBZnZBYhthYBYgq\\qgYBYgqYrYqgYBYgq\\qgYBZgtgZBeZlZeCeZjZeEe`eGlD","hole-filled":"16LLLAMANAMFXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYMAM[MZM]MCMAYMYNYNAMLF",hole:"16LLLYA\\AYGbEYA`AYDdCYAbAYB\\MYNYM\\A\\MYMZMYM\\AZMYMYNYMYMZCZTZCZMYRYMZCZTZEYTYHRLI","key-holder":"16LFdCYpYAZ{e\\qbe\\qYeYhYeYe\\qZfZfZe\\qYgZgYe\\qYgYhYe\\qZfZfZe\\qYeYhYeYe\\qbe\\oq[edqZpfYAdZA",key:"16FtKqPqIqMhMqHqMYNeMqHqMYNeMqHqM\\MqIqNYMqJqMeYMqJqNYMqJqMZMqKqNqLArLLLLLK",lock:"16FPKMtMIMq\\qMGMZhYqMEMZeqNYeYqMCNYeqPYeYqMAOYeqPYeYrPYfqNYfYrO[eqNYeYfqMYM\\ereYgMYAYM\\fYgMYCYM[MYgMYEYMYMfYeMYGYMhMYIYPYK\\F",rock:"16FPIOhNFMeresfMDMerYeueMCMfqZesfqMBMgqZgYfMBMiYgZNBNYkZqNBNYiZsMBMqgriqMAMqeqYgqMYgMAMYfqMYeqMYgMAMZeqMYfNYfMAOZNYPYMqBPEOLF",sand:"16ZMYV]MYV]MYW\\MYMYU^MYU^MZU^MZV]MYV]XM\\XM\\X[XN[XM\\X]XZ",spiral:"16FPJYSFRYQDiMZPIeSHfMYPIeM[OGeMZQGeMYRGeMYRGeSIeRJePLfNLLJ",trap:"16DNANANGVEQrQCNYM[N[NBMqMrYrMrMqMANZM\\q\\OqMrMYsMrMqO]N]OsNsMqYsN\\qYM]qYOqMqOsYrNAqZN[M[MqBNYqMsMrOCO[rZNFQrMJPF"},TILE_SIZE=16;let zoomFactor=1;const LEVEL_WIDTH=20,LEVEL_HEIGHT=10,MAX_STEPS_ALLOWED=13,RESPAWN_RESET_DELAY=600,uiCanvas=document.getElementById("uiCanvas"),uiCtx=uiCanvas.getContext("2d"),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),backgroundCanvas=document.getElementById("gameBackgroundCanvas"),backgroundCtx=backgroundCanvas.getContext("2d");let backgroundTile,backgroundColors,collectedKeysNumber=0;const ORIENTATION_UP=0,ORIENTATION_RIGHT=1,ORIENTATION_DOWN=2,ORIENTATION_LEFT=3,DEFAULT_ANIMATION_INTERVAL=200,DEFAULT_REMOVAL_DURATION=225,COLOR_SETS={blueGreenSet:["#024d53","#599dbc","#72d1c7","#a9ffe6"],crateSet:["#000","#893a25","#f89e61","#863422"],greenSet:["#000","#527f67","#a2ce69","#d6f8e1"],sandSet:["#cab168","#e5d09e"],bronzeSet:["#000","#811c07","#ca6137","#ffb59c"]},DEFAULT_TILE_COLORS={arrow:COLOR_SETS.blueGreenSet,block:COLOR_SETS.blueGreenSet,character:["#000","#e42c37","#c07548","#fdcbb0"],crate:COLOR_SETS.crateSet,lock:COLOR_SETS.greenSet,key:COLOR_SETS.greenSet,flag:COLOR_SETS.bronzeSet,"key-holder":COLOR_SETS.blueGreenSet,rock:COLOR_SETS.blueGreenSet,sand:COLOR_SETS.sandSet,gong:COLOR_SETS.bronzeSet,"gong-trigger":COLOR_SETS.bronzeSet,spiral:COLOR_SETS.blueGreenSet};let levelData=[{tile:"arrow",x:4,y:7},{tile:"arrow",x:4,y:6,orientation:ORIENTATION_LEFT},{tile:"arrow",x:2,y:4,orientation:ORIENTATION_LEFT},{tile:"crate",x:3,y:6},{tile:"crate",x:4,y:6},{tile:"rock",x:11,y:2},{tile:"rock",x:1,y:3},{tile:"rock",x:2,y:3},{tile:"rock",x:3,y:3},{tile:"rock",x:4,y:3},{tile:"rock",x:5,y:3},{tile:"rock",x:6,y:3},{tile:"rock",x:7,y:3},{tile:"rock",x:12,y:3},{tile:"rock",x:13,y:3},{tile:"rock",x:14,y:3},{tile:"rock",x:15,y:3},{tile:"rock",x:16,y:3},{tile:"rock",x:17,y:3},{tile:"rock",x:18,y:3},{tile:"rock",x:4,y:4},{tile:"rock",x:5,y:4},{tile:"rock",x:14,y:4},{tile:"rock",x:16,y:4},{tile:"rock",x:1,y:5},{tile:"rock",x:2,y:5},{tile:"rock",x:5,y:5},{tile:"rock",x:14,y:5},{tile:"rock",x:16,y:5},{tile:"block",x:8,y:3,orientation:ORIENTATION_LEFT},{tile:"block",x:9,y:3,orientation:ORIENTATION_LEFT},{tile:"flag",x:9,y:2},{tile:"block",x:10,y:3,color:COLOR_SETS.greenSet,orientation:ORIENTATION_LEFT,isPushable:!0},{tile:"lock",x:11,y:3},{tile:"key-holder",x:15,y:4},{tile:"key",x:15,y:4},{tile:"gong-trigger",x:1,y:4},{tile:"gong",x:15,y:5}],zzfx=(...e)=>zzfxP(zzfxG(...e)),zzfxP=(...e)=>{let t=zzfxX.createBufferSource(),M=zzfxX.createBuffer(e.length,e[0].length,zzfxR);return e.map(((e,t)=>M.getChannelData(t).set(e))),t.buffer=M,t.connect(zzfxX.destination),t.start(),t},zzfxG=(e=1,t=.05,M=220,r=0,a=0,n=.1,o=0,c=1,i=0,l=0,s=0,N=0,E=0,T=0,h=0,Y=0,f=0,q=1,u=0,L=0)=>{let d,g,O=2*Math.PI,m=i*=500*O/zzfxR**2,I=(0<h?1:-1)*O/4,A=M*=(1+2*t*Math.random()-t)*O/zzfxR,S=[],v=0,C=0,F=0,R=1,_=0,k=0,x=0;for(l*=500*O/zzfxR**3,h*=O/zzfxR,s*=O/zzfxR,N*=zzfxR,E=zzfxR*E|0,g=(r=99+zzfxR*r)+(u*=zzfxR)+(a*=zzfxR)+(n*=zzfxR)+(f*=zzfxR)|0;F<g;S[F++]=x)++k%(100*Y|0)||(x=o?1<o?2<o?3<o?Math.sin((v%O)**3):Math.max(Math.min(Math.tan(v),1),-1):1-(2*v/O%2+2)%2:1-4*Math.abs(Math.round(v/O)-v/O):Math.sin(v),x=(E?1-L+L*Math.sin(2*Math.PI*F/E):1)*(0<x?1:-1)*Math.abs(x)**c*e*zzfxV*(F<r?F/r:F<r+u?1-(F-r)/u*(1-q):F<r+u+a?q:F<g-f?(g-F-f)/n*q:0),x=f?x/2+(f>F?0:(F<g-f?1:(g-F)/f)*S[F-f|0]/2):x),d=(M+=i+=l)*Math.sin(C*h-I),v+=d-d*T*(1-1e9*(Math.sin(F)+1)%2),C+=d-d*T*(1-1e9*(Math.sin(F)**2+1)%2),R&&++R>N&&(M+=s,A+=s,R=0),!E||++_%E||(M=A,i=m,R=R||1);return S},zzfxV=.3,zzfxR=44100,zzfxX=new(window.AudioContext||webkitAudioContext),pixelList=[];function decodeRLE(e){const t="A".charCodeAt(0),M=[],r=parseInt(e.match(/^\d+/)[0],10);e=e.replace(/^\d+/,"");for(let r=0;r<e.length;++r){const a=e[r].charCodeAt(0)-t,n=Math.floor(a/12),o=a%12+1;M.push(...Array(o).fill(n))}return{pixels:M,imageWidth:r}}function convertTo2DArray(e,t){const M=[];for(let r=0;r<e.length;r+=t)M.push(e.slice(r,r+t));return M}function sliceIntoTiles(e,t,M){const r=[],a=e.length,n=e[0].length;for(let o=0;o<a;o+=M)for(let a=0;a<n;a+=t){const n=[];for(let r=0;r<M;r++)n.push(e[o+r].slice(a,a+t));r.push(n)}return r}function processSprite(e){const t=decodeRLE(IMAGE_LIST[e]);pixelList=t.pixels;return{tiles:sliceIntoTiles(convertTo2DArray(t.pixels,t.imageWidth),16,16)}}function processAllSprites(){const e=[];for(const t in IMAGE_LIST)e[t]=processSprite(t);return e}const GAME_SPRITES=processAllSprites();function isInBounds(e,t){return e>=1&&e<LEVEL_WIDTH-1&&t>=1&&t<LEVEL_HEIGHT-1}const initialLevelData=JSON.parse(JSON.stringify(levelData));function resetLevel(){levelData=JSON.parse(JSON.stringify(initialLevelData)),levelData.forEach((e=>{GAME_SPRITES[e.tile].tiles.length>1&&(e.animationFrame=0,e.elapsed=0),e.isBeingRemoved=!1,e.scale=1})),characterX=initialX,characterY=initialY,characterScale=1,stepsPerformed=0}function getTileAt(e,t){let M=null;for(const r of levelData)r.x===e&&r.y===t&&(M=r.tile);return M}function removeTile(e,t=null,M=null){levelData=levelData.filter((r=>r.tile!==e||null!==t&&null!==M&&(r.x!==t||r.y!==M)))}function tryMoveCrate(e,t,M,r){const a=e+M,n=getTileAt(a,t+r);if(isInBounds(a,a)&&(null===n||["arrow"].includes(n)))for(const a of levelData)if(a.x===e&&a.y===t&&"crate"===a.tile)return startCrateAnimation(a,M,r),playActionSound("crate"),!0;return!1}function startCrateAnimation(e,t,M){movingCrate=e,crateMoveStartX=e.x,crateMoveStartY=e.y,crateMoveTargetX=crateMoveStartX+t,crateMoveTargetY=crateMoveStartY+M,crateMoveElapsedTime=0}function removeConnectedBlocks(e,t,M,r){animateTileRemoval("block",e,t);const a=e+M,n=t+r;if("block"===getTileAt(a,n)){const e=levelData.find((e=>e.x===a&&e.y===n&&"block"===e.tile));if(e){const t=e.orientation||ORIENTATION_UP;let M=0,r=0;t===ORIENTATION_LEFT?M=-1:t===ORIENTATION_RIGHT?M=1:t===ORIENTATION_UP?r=-1:t===ORIENTATION_DOWN&&(r=1),setTimeout((()=>{removeConnectedBlocks(a,n,M,r)}),120)}}}function animateTileRemoval(e,t=null,M=null,r,a=DEFAULT_REMOVAL_DURATION){levelData.filter((r=>r.tile===e&&(null===t||r.x===t&&r.y===M))).forEach((e=>{e.isBeingRemoved=!0,e.scale=1,e.elapsed=0,e.removalDuration=a,e.removeCallback=r}))}function refreshUI(){drawUI()}function drawUI(){uiCtx.fillStyle="#333",uiCtx.fillRect(0,0,uiCanvas.width,uiCanvas.height),adjustFontSize(`Steps: ${stepsPerformed}`),uiCtx.fillStyle="white";const e=uiCanvas.height/2+uiCtx.font.match(/\d+/)[0]/2;uiCtx.fillText(`Steps: ${stepsPerformed}`,.02*uiCanvas.width,e);drawTile(GAME_SPRITES.key.tiles[0],DEFAULT_TILE_COLORS.key,4.5,.75,{context:uiCtx}),uiCtx.fillText(`x${collectedKeysNumber}`,.28*uiCanvas.width,e),uiCtx.fillText("R: Reset",.8*uiCanvas.width,.7*e),uiCtx.fillText("Undo",.8*uiCanvas.width,1.3*e)}function adjustFontSize(e){let t=e.length;for(uiCtx.font="40px Arial";uiCtx.measureText(e).width>uiCanvas.width*t*.02;)uiCtx.font=parseInt(uiCtx.font)-1+"px Arial"}let crateMoveStartX,crateMoveStartY,crateMoveTargetX,crateMoveTargetY,movingCrate=null,crateMoveElapsedTime=0;const CRATE_MOVE_DURATION=200;function tryPerformAction(e,t,M,r,a,n){let o=!1;switch(a){case"crate":tryMoveCrate(e,t,M,r)&&(o=!0);break;case"key":o=!0,removeTile("key"),collectedKeysNumber++;break;case"lock":collectedKeysNumber>0&&(o=!0,animateTileRemoval("lock",e,t,(()=>{collectedKeysNumber--})));break;case"flag":return resetLevel(),!1;case"block":const a=levelData.find((M=>M.x===e&&M.y===t&&"block"===M.tile));if(a){const n=a.orientation||ORIENTATION_UP;a.isPushable&&(n===ORIENTATION_LEFT&&-1===M||n===ORIENTATION_RIGHT&&1===M||n===ORIENTATION_UP&&-1===r||n===ORIENTATION_DOWN&&1===r)&&(removeConnectedBlocks(e,t,M,r),o=!0)}break;case"gong-trigger":n.triggered||(n.triggered=!0,o=!0,animateTileRemoval("gong"))}return o}function refreshCanvas(){drawLevel(),refreshUI(),drawCharacter()}function drawLevel(){drawLevelBackground("sand","rock"),drawLevelElements(levelData),backgroundCtx.drawImage(canvas,0,0,backgroundCanvas.width,backgroundCanvas.height)}function drawLevelBackground(e,t){backgroundTile=GAME_SPRITES[e].tiles[0],backgroundColors=DEFAULT_TILE_COLORS[e];const M=GAME_SPRITES[t].tiles[0],r=DEFAULT_TILE_COLORS[t];for(let e=0;e<LEVEL_HEIGHT;e++)for(let t=0;t<LEVEL_WIDTH;t++)drawTile(backgroundTile,backgroundColors,t,e),0!==t&&t!==LEVEL_WIDTH-1&&0!==e&&e!==LEVEL_HEIGHT-1||drawTile(M,r,t,e)}function drawLevelElements(e){e.forEach((e=>{drawTile(GAME_SPRITES[e.tile].tiles[e.animationFrame||0],e.color||DEFAULT_TILE_COLORS[e.tile],e.x,e.y,{orientation:e.orientation||ORIENTATION_UP,scale:e.scale||1})}))}function drawTile(e,t,M,r,a={}){const{orientation:n=ORIENTATION_UP,scale:o=e.scale||1,context:c=ctx,flipHorizontally:i=!1}=a;c.save();const l=TILE_SIZE*zoomFactor/2;c.translate((M+.5)*TILE_SIZE*zoomFactor,(r+.5)*TILE_SIZE*zoomFactor);let s=1;i&&(s=-1),c.scale(o*s,o),c.rotate(n*Math.PI/2),c.translate(-l,-l);for(let M=0;M<e.length;M++)for(let r=0;r<e[M].length;r++){const a=e[M][r];a>0&&(c.fillStyle=t[a-1],c.fillRect(r*zoomFactor,M*zoomFactor,zoomFactor,zoomFactor))}c.restore()}const keyStack=[];function handleKeyDown(e){const t=mapKeyToDirection(e.key);t&&!keyStack.includes(t)&&keyStack.push(t)}function handleKeyUp(e){const t=mapKeyToDirection(e.key);if(t){const e=keyStack.indexOf(t);-1!==e&&keyStack.splice(e,1)}"r"===e.key&&resetLevel(),hasPlayedWallSoundDuringKeyHold=!1}function mapKeyToDirection(e){switch(e){case"ArrowUp":case"z":case"w":return"up";case"ArrowDown":case"s":return"down";case"ArrowLeft":case"q":case"a":return"left";case"ArrowRight":case"d":return"right";default:return null}}window.addEventListener("keydown",handleKeyDown),window.addEventListener("keyup",handleKeyUp);let characterX=9,characterY=7,characterScale=1,characterDirection=ORIENTATION_DOWN,initialX=characterX,initialY=characterY,isCharacterMoving=!1,characterMoveStartX=characterX,characterMoveStartY=characterY,characterMoveTargetX=characterX,characterMoveTargetY=characterY,characterMoveFrame=0;const CHARACTER_MOVE_DURATION=300;let spawnReturnTimeout,characterMoveElapsedTime=0,isReturningToSpawn=!1,characterReturnStartTime=0;const CHARACTER_RETURN_DURATION=400;let returnStartX,returnStartY,stepsPerformed=0;function drawCharacter(){drawTile(GAME_SPRITES.characters.tiles[characterMoveFrame],DEFAULT_TILE_COLORS.character,characterX,characterY,{scale:characterScale,flipHorizontally:characterDirection===ORIENTATION_RIGHT})}function canMoveTo(e,t,M=0,r=0){if(movingCrate||isCharacterMoving||isReturningToSpawn)return!1;if(!isInBounds(e,t))return playActionSound("wall"),!1;const a=getTileAt(e,t),n=levelData.find((M=>M.x===e&&M.y===t));if(n&&n.isBeingRemoved)return!1;let o=tryPerformAction(e,t,M,r,a,n);return o&&playActionSound(a),!![null,"arrow","key","key-holder","flag"].includes(a)||(o?++stepsPerformed:playActionSound("wall"),!1)}function moveCharacter(e,t,M){if(isReturningToSpawn||isCharacterMoving)return;const r=characterX+e,a=characterY+t;setCharacterDirection(M),canMoveTo(r,a,e,t)&&(stepsPerformed<MAX_STEPS_ALLOWED&&(isCharacterMoving=!0,characterMoveStartX=characterX,characterMoveStartY=characterY,characterMoveTargetX=r,characterMoveTargetY=a,characterMoveElapsedTime=0),stepsPerformed=Math.min(stepsPerformed+1,MAX_STEPS_ALLOWED),stepsPerformed>=MAX_STEPS_ALLOWED&&!spawnReturnTimeout&&(spawnReturnTimeout=setTimeout((()=>{isReturningToSpawn=!0,returnStartX=characterX,returnStartY=characterY,characterReturnStartTime=performance.now(),stepsPerformed=0,spawnReturnTimeout=null}),RESPAWN_RESET_DELAY)))}function setCharacterDirection(e){characterDirection=e,characterMoveFrame=getMoveFrameFromDirection(characterDirection)}function getMoveFrameFromDirection(e){switch(e){case ORIENTATION_UP:return 2;case ORIENTATION_RIGHT:case ORIENTATION_LEFT:return 1;case ORIENTATION_DOWN:return 0}}let lastFrameTime=0;function animate(e){updateAnimations(e-lastFrameTime),isReturningToSpawn&&returnCharacterToSpawn(),refreshCanvas(),lastFrameTime=e,requestAnimationFrame(animate)}function updateAnimations(e){if(levelData.forEach((t=>{if(GAME_SPRITES[t.tile].tiles.length>1){t.elapsed=(t.elapsed||0)+e;const M=t.animationInterval||DEFAULT_ANIMATION_INTERVAL;t.elapsed>=M&&(t.animationFrame=(t.animationFrame+1)%GAME_SPRITES[t.tile].tiles.length,t.elapsed=0)}if(t.isBeingRemoved){t.elapsed=(t.elapsed||0)+e;const M=t.removalDuration||DEFAULT_REMOVAL_DURATION;t.scale=Math.max(1-t.elapsed/M,0),t.scale<=0&&(removeTile(t.tile,t.x,t.y),t.removeCallback&&t.removeCallback())}})),!isCharacterMoving&&!isReturningToSpawn&&keyStack.length>0){switch(keyStack[keyStack.length-1]){case"up":moveCharacter(0,-1,ORIENTATION_UP);break;case"down":moveCharacter(0,1,ORIENTATION_DOWN);break;case"left":moveCharacter(-1,0,ORIENTATION_LEFT);break;case"right":moveCharacter(1,0,ORIENTATION_RIGHT)}}isCharacterMoving&&playCharacterAnimation(e),movingCrate&&animateCrate(e)}function playCharacterAnimation(e){characterMoveElapsedTime+=e;const t=Math.min(characterMoveElapsedTime/CHARACTER_MOVE_DURATION,1);characterX=characterMoveStartX+(characterMoveTargetX-characterMoveStartX)*t,characterY=characterMoveStartY+(characterMoveTargetY-characterMoveStartY)*t;let M=getMoveFrameFromDirection(characterDirection);switch(Math.floor(3*t)){case 0:characterMoveFrame=M+3;break;case 1:characterMoveFrame=M;break;case 2:characterMoveFrame=M+6}t>=1&&(isCharacterMoving=!1,characterX=characterMoveTargetX,characterY=characterMoveTargetY,characterMoveElapsedTime=0,characterMoveFrame=M)}function returnCharacterToSpawn(){const e=performance.now()-characterReturnStartTime,t=Math.min(e/CHARACTER_RETURN_DURATION,1);t<.5?(characterScale=1-2*t,characterX=returnStartX,characterY=returnStartY):(characterScale=2*(t-.5),characterX=initialX,characterY=initialY,setCharacterDirection(ORIENTATION_DOWN)),t>=1&&(isReturningToSpawn=!1,characterX=initialX,characterY=initialY,characterScale=1,levelData=levelData.filter((e=>"spiral"!==e.tile)))}function animateCrate(e){crateMoveElapsedTime+=e;const t=Math.min(crateMoveElapsedTime/CRATE_MOVE_DURATION,1);movingCrate.x=crateMoveStartX+(crateMoveTargetX-crateMoveStartX)*t,movingCrate.y=crateMoveStartY+(crateMoveTargetY-crateMoveStartY)*t,t>=1&&(movingCrate.x=crateMoveTargetX,movingCrate.y=crateMoveTargetY,crateMoveElapsedTime=0,movingCrate=null)}let hasPlayedWallSoundDuringKeyHold=!1;function playActionSound(e){switch(e){case"gong-trigger":zzfx(...[,0,523.2511,.02,,1.5,1,.5,-.05,.5,,,.3,.05,,,.05,.8,,.05]);break;case"crate":zzfx(...[,.1,150,.05,,,,1.3,,,,,,3]);break;case"key":zzfx(...[,0,1320,,.1,.3,1,1.82,,,880,.05]);break;case"wall":hasPlayedWallSoundDuringKeyHold||(hasPlayedWallSoundDuringKeyHold=!0,zzfx(...[,0,440,.15,.01,.12,1,1.59,-6.98,4.97]));break;default:console.warn(`No sound effect for tile: ${e}`)}}function setZoomFactor(){zoomFactor=Math.min(Math.floor(window.innerWidth/(LEVEL_WIDTH*TILE_SIZE)),Math.floor(window.innerHeight/(LEVEL_HEIGHT*TILE_SIZE))),canvas.width=LEVEL_WIDTH*TILE_SIZE*zoomFactor,canvas.height=LEVEL_HEIGHT*TILE_SIZE*zoomFactor,uiCanvas.width=canvas.width,uiCanvas.height=TILE_SIZE*zoomFactor*2,window.innerWidth/window.innerHeight>LEVEL_WIDTH/LEVEL_HEIGHT?(backgroundCanvas.width=window.innerWidth,backgroundCanvas.height=window.innerWidth*(LEVEL_HEIGHT/LEVEL_WIDTH)):(backgroundCanvas.height=window.innerHeight,backgroundCanvas.width=window.innerHeight*(LEVEL_WIDTH/LEVEL_HEIGHT))}function initGame(){ctx.imageSmoothingEnabled=!1,levelData.forEach((e=>{e.animationFrame=0})),window.addEventListener("resize",setZoomFactor),setZoomFactor(),requestAnimationFrame(animate)}initGame();</script></body></html>