<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>13 steps to death</title><style>body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      body:not(.game) {
        .-game {
          display: none;
        }
      }
      body:not(.editor) {
        .-editor {
          display: none;
        }
      }

      #game {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #gBC {
        position: absolute;
        top: -5%;
        left: -5%;
        width: 110%;
        height: 110%;
        z-index: -1;
        object-fit: cover;
        filter: blur(15px) brightness(50%);
      }</style></head><body oncontextmenu="return!1"><div id="game"><canvas id="gBC"></canvas><canvas id="uiCanvas" class="-game"></canvas><div id="editor" class="-editor"><div id="editorUi"><label>Tile: <select id="eTS"></select></label> <label>Orientation: <select id="eOS"><option value="0">Up</option><option value="1">Right</option><option value="2">Down</option><option value="3">Left</option></select></label> <button id="editorTestLevelButton">Test level</button><p id="editorMessage"></p></div></div><canvas id="gC"></canvas><script>!function(){"use strict";let e=e=>document.querySelector(e),t=(e,t)=>localStorage.setItem(e,t),M=e=>localStorage.getItem(e);const r={blueGreen:["#024d53","#599dbc","#72d1c7","#a9ffe6"],c:["#000","#893a25","#f89e61","#c16c43"],green:["#000","#527f67","#a2ce69","#d6f8e1"],sand:["#e5d09e","#cab168"],bronze:["#000","#811c07","#ca6137","#ffb59c"],purple:["#341b2e","#6a5979","#937cb2","#afbeff"]},n={arrow:{r:"16LKZLA\\K^LZLBZLBZLLLLLLLLLLLLG",co:r.blueGreen,limit:0,iS:!0},block:{r:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",co:r.blueGreen,cCO:!0},"bT":{r:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",co:r.green,cCO:!0},boulder:{r:"16LIRHNgqYqNEMgsZrMCMfrYrZsMBMesYqZtMAMfYrYq^qNfZqZuZNerYrYvYN]q[tYNtYs^MAMs[uYMBM\\q[q[MCMtYq\\MENs[NHRE",co:r.c},c:{r:"16AXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYO[MZM]OYNYMYNYPYNYMZMYNYMZMYNYPYNYMYNYO]MZM[NAXNA",co:r.c},f:{r:"48DYLCYLCYLBZLBZLBZLCMgLMlGMlGMkHMkHMkHMkHMkHMkHMkHMkHMkHMkHMlGMkHMFfGMLCMChHMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLBZLBZLBZK",co:r.bronze,limit:1},"gong-trigger":{r:"16XQsevesNqfTfqNfOhNgNfNeteNfNfMeqPqeMfMAMeMeqMrMqeMeMBMeMeqPqeMeMBMeNeteNeMBMeMAMhMAMeMBMeMBPBMeMBMeMHMeMBMeMHMeMBMeMAQBMeMBMeMBQAMeMBOHOA",co:r.bronze,iS:!0},gong:{r:"16F\\JZtZGYfvYEZe^rYC\\jYrYB[lYqYBZnZBYhthYBYgq\\qgYBYgqYrYqgYBYgq\\qgYBZgtgZBeZlZeCeZjZeEe`eGlD",co:r.bronze},"hF":{r:"16LLLAMANAMFXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYMAM[MZM]MCMAYMYNYNAMLF",co:r.c},h:{r:"16LLLYA\\AYGbEYA`AYDdCYAbAYB\\MYNYM\\A\\MYMZMYM\\AZMYMYNYMYMZCZTZCZMYRYMZCZTZEYTYHRLI",co:["#000","#00506e"]},"kH":{r:"16LFdCYpYAZ{e\\qbe\\qYeYhYeYe\\qZfZfZe\\qYgZgYe\\qYgYhYe\\qZfZfZe\\qYeYhYeYe\\qbe\\oq[edqZpfYAdZA",co:r.blueGreen,limit:0,iS:!0},key:{r:"16FtKqPqIqMhMqHqMYNeMqHqMYNeMqHqM\\MqIqNYMqJqMeYMqJqNYMqJqMZMqKqNqLArLLLLLK",co:r.green},lock:{r:"16FPKMtMIMq\\qMGMZhYqMEMZeqNYeYqMCNYeqPYeYqMAOYeqPYeYrPYfqNYfYrO[eqNYeYfqMYM\\ereYgMYAYM\\fYgMYCYM[MYgMYEYMYMfYeMYGYMhMYIYPYK\\F",co:r.green},rock:{r:"16FPIOhNFMeresfMDMerYeueMCMfqZesfqMBMgqZgYfMBMiYgZNBNYkZqNBNYiZsMBMqgriqMAMqeqYgqMYgMAMYfqMYeqMYgMAMZeqMYfNYfMAOZNYPYMqBPEOLF",co:r.blueGreen,iS:!0},"spawn-current":{r:"16E\\LBYAYJZBYAYJZAYAYJYAYBYBYD[F[AYAYEZCYBZAZB\\AYB\\BYA\\BZAZBYCZEYAYA[F[DYBYBYAYJYAYAZJYAYBZJYAYLB\\E",co:r.blueGreen,limit:1},spawn:{r:"32E\\L\\LBYAYLAYAYJZBYAYIZBYAYJZAYAYJZAYAYJYAYBYBYGYAYBYBYD[F[AYB[F[AYAYEfCYBYAYErCYBZAZBhAYB[AZBtAYB\\BYAhBZA[BYAtBZAZBYCfEYAYBYCrEYAYA[F[BYA[F[DYBYBYAYGYBYBYAYJYAYAZJYAYAZJYAYBZIYAYBZJYAYLAYAYLB\\L\\E",co:r.blueGreen},trap:{r:"16DNANANGVEQfQCNYM[N[NBMeMfYfMfMeMANZM\\e\\OeMfMYgMfMeO]N]OgNgMeYgN\\eYM]eYOeMeOgYfNAeZN[M[MeBNYeMgMfOCO[fZNFQfMJPF",co:["#306710","#000","#b1712e"]},sand:{r:"16ZMYV]MYV]MYW\\MYMYU^MYU^MZU^MZV]MYV]XM\\XM\\X[XN[XM\\X]XZ",co:r.sand,limit:0},characters:{r:"144FPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFMlMGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMesereMEMeugMFMlMFMlMEMmMFMlMFMlMEMmMFMlMEMqeveqMEMufNEMqlqMEMereseMEMeugMFMlMFMereseMEMeugMFMlMFMrMrMrMFMqMseMqMFMlMEMqeveqMEMufNEMqlqMDMqeveqMEMufNEMqlqMFMqMrMqMGMqMuMHMjMGMrMrMrMFMqMseMqMFMlMFMrMrMrMFMqMseMqMFMlMFOtOGMtNHOtOFNqMrMqNFMqMuMHNhNGNqMrMqNFMqMuMHNhNFM[P[MGPYMGM[P[MDMZMtMZMFMtNHMZPZMEMZMtMZMFMtOGMZPZMDMZMZrZMZMFN[MFMZM^MZMCOYPYMYqMEQYNFMqM^OCMqYMYPYOFQ[MEO^MqMCMZM^MZMFMYMZMFMZM^MZMCMrM]NqMDMr\\MqMFN]MrMCMqN]MrMEMqNZMYqMEMrM]NEMqTqMGMYMqNGMqTqMEUANEO\\MHUDNAUGN\\MqMFUGN^NHOqMIN^NHMqNZMISHMZNqMIMZNqMJSIMqNZMHMrNrMIMrNJMrNrMJOrMHMrNrMHMrOJMrOJMrNrMJOrMJPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFNjNGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFNjNFMlMEMmMFNjNFMgqhMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMeveMEMerjMFMlMFMgqhMEMmMFMlMFMgqhMEMmMFMlMEMqeveqMEMshMeMDMqlqMEMeveMEMerjMFMlMFMeveMEMerjMFMlMFMeqMrMqeMFMqMqgMqMeMDMgNgMEMqeveqMEMshMeMDMqlqMDMqeveqMEMshMeMDMqlqMFMqMrMqMGMqMqfrMfMEMeMfMeMGMeqMrMqeMFMqMqgMqMeMDMgNgMFMeqMrMqeMFMqMqgMqMeMDMgNgMGNtNHMtNfMFNhNHMqMrMqMGMqMqfrMfMEMeMfMeMHMqMrMqMGMqMqfrMfMEMeMfMeMGMZPZMHSeMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFM[r[MGMYNYMANFMZMfMZMFMYQYNHSfMDMYMgPFNYQYMGTfMDMYNgOEMqN\\NqMFMZMqMHMqNYNYNqMEO\\MrMFMZqNqODMrNeQEMrM\\OGM[MrOEQeNrMCMrN\\NrMFMYMqMGMrN\\NrMCMrM\\PFMsPFPYNYMrMDP\\MrMEMqMZNqMFMrMYNYPDOrNrOGMrNHOrNrOEOqNrMIOYqMIMrNqOGMrNqOGMrNYNGOqNrMIMqNqMKMqMLMqNqMKOqMJMqNqMJMqOKMqOJMqOqMKOqME",co:["#000","#e42c37","#c07548","#fdcbb0"],limit:0},spikes:{r:"16LEpeBe|qeA|sArgqgqgrAreMeqeMeqeMerArgqgqgrA|sArgqgqgrAreMeqeMeqeMerArgqgqgrA|sArgqgqgrAreMeqeMeqeMerArgqgqgrB|qB",co:r.blueGreen},"switch-off":{r:"16LLIpfBedeBeZxZeBeYzYeBeYs\\sYeBeYs\\sYeBeYs\\sYeBeYzYeBeYzYeBeZxZeBedeBpfLLI",co:r.purple},"switch-on":{r:"16CVEMexeMDMqftfqMCeMqeqPqeqMeBeMqeqPqeqMeBeMqeqPqeqMeBeMqftfqMeBeMexeMeBeNlNeBeMqZereZqMeBeMeqZfZqeMeBeMYerfreYMeBeNYe\\eYNeBeXeBiDiLE",co:r.purple},"switch-trigger":{r:"16Zp[pfYplTkMxMjMxMjMrPrMjMrPrMjMrPrMjMxMjMxMjM`MjYTYk`hYpf[pZ",co:r.purple}},l=16,i=13,o=20,a=10,c={f:200,spawn:600},s=225,Y=125,N=300,f=400,q=0,h=1,u=2,g=3,d=[];["","-6N-F-N-13N-3N-7N7Bz2CzMN7-2GAz-N2-6NLN-2N4-2N-6NHN-6E2-17A-2O","-2N-3N5-9N-E-J-MCxBx2By-7N-3N5-By-7N-N-N5-N-5N3-E-P-2JE-N-5LJ2-E-N5-N-5N11HN-2F-2G-5Q5ON","-6NGN-5EQN2-6N-N-5N-N2-4F-M-M-2O-2Cz-CzL-6N-N-2E-2N-NQ-6N5CN3-NQ-8N-7NQ-8N3JN5Q-8NL-4HQ2P","-7Bz8N-9NEN5CN-6O-2Q-Q-4H-6E-3Q-Q-5P-5W-3NTN7MN-7V-2WN-6N3VN4UN3-3F-2N3GN4L-N2"].forEach((e=>{const t=z(e);d.push(t)}));const Z={letters:{1:"010110010010111",2:"01101001001001001111",3:"11100001001100011110",4:"00110101100111110001",5:"11111000111100011110",6:"01101000111010010110",7:"11110001001000100010",8:"01101001011010010110",9:"01101001011100010110",0:"01101001100110010110",A:"01101001111110011001",B:"110101110101110",C:"011100100100011",D:"110101101101110",E:"111100111100111",F:"111100111100100",G:"01111000101110010110",H:"10011001111110011001",I:"111010010010111",J:"00010001000110010110",K:"10011010110010101001",L:"100100100100111",M:"1000111011101011000110001",N:"10011101101110011001",O:"01101001100110010110",P:"11101001111010001000",Q:"01101001100110100101",R:"11101001111010101001",S:"01111000011000011110",T:"111010010010010",U:"10011001100110010110",V:"1000110001010100101000100",W:"1010110101101010101001010",X:"10011001011010011001",Y:"10011001111100011110",Z:"11110001011010001111"," ":"000000000000000",",":"000000000001001",".":"000000000000001","!":"010010010000010","/":"0000100010001000100010000",":":"000010000010000",x:"000000101010101"},defaultOptions:{x:0,y:0,scale:1,text:"",vspacing:1,hspacing:1,color:"rgb(255,255,255)"},textLine:function(e){let t=0;for(let M=0;M<e.text.length;M++){const r=e.text.charAt(M),n=this.letters[r]||this.letters.unknown,l=n.length/5;for(let r=0;r<5;r++)for(let i=0;i<l;i++){"1"===n[r*l+i]&&e.ctx.rect((e.x+((i+t)*e.scale+e.hspacing*M))*w,(e.y+r)*e.scale*w,w*e.scale,w*e.scale)}t+=l}},text:function(e){const t={ctx:p,...this.defaultOptions,...e},M=t.text.split("\n"),r=5*w*t.scale;t.ctx.beginPath();for(let e=0;e<M.length;e++){const n=M[e],l=t.x,i=t.y+(r+t.vspacing*w)*e;Z.textLine({ctx:t.ctx,x:l,y:i,text:n,hspacing:t.hspacing,scale:t.scale})}t.ctx.fillStyle=t.color,t.ctx.fill()}},A=e("#uiCanvas"),L=A.getContext("2d"),E=e("#gC"),p=E.getContext("2d"),B=e("#gBC"),x=B.getContext("2d");let F,b="menu",w=1,m=0,y=0;const C=[];let k=1,O=e("#eTS"),v=e("#eOS"),D={x:-1,y:-1},G=(...e)=>H(P(...e)),H=(...e)=>{let t=S.createBufferSource(),M=S.createBuffer(e.length,e[0].length,I);return e.map(((e,t)=>M.getChannelData(t).set(e))),t.buffer=M,t.connect(S.destination),t.start(),t},P=(e=1,t=.05,M=220,r=0,n=0,l=.1,i=0,o=1,a=0,c=0,s=0,Y=0,N=0,f=0,q=0,h=0,u=0,g=1,d=0,Z=0)=>{let A,L,E=2*Math.PI,p=a*=500*E/I**2,B=(0<q?1:-1)*E/4,x=M*=(1+2*t*Math.random()-t)*E/I,F=[],b=0,w=0,m=0,y=1,C=0,k=0,O=0;for(c*=500*E/I**3,q*=E/I,s*=E/I,Y*=I,N=I*N|0,L=(r=99+I*r)+(d*=I)+(n*=I)+(l*=I)+(u*=I)|0;m<L;F[m++]=O)++k%(100*h|0)||(O=i?1<i?2<i?3<i?Math.sin((b%E)**3):Math.max(Math.min(Math.tan(b),1),-1):1-(2*b/E%2+2)%2:1-4*Math.abs(Math.round(b/E)-b/E):Math.sin(b),O=(N?1-Z+Z*Math.sin(2*Math.PI*m/N):1)*(0<O?1:-1)*Math.abs(O)**o*e*J*(m<r?m/r:m<r+d?1-(m-r)/d*(1-g):m<r+d+n?g:m<L-u?(L-m-u)/l*g:0),O=u?O/2+(u>m?0:(m<L-u?1:(L-m)/u)*F[m-u|0]/2):O),A=(M+=a+=c)*Math.sin(w*q-B),b+=A-A*f*(1-1e9*(Math.sin(m)+1)%2),w+=A-A*f*(1-1e9*(Math.sin(m)**2+1)%2),y&&++y>Y&&(M+=s,x+=s,y=0),!N||++C%N||(M=x,a=p,y=y||1);return F},J=.3,I=44100,S=new(window.AudioContext||webkitAudioContext),Q=[];function j(e){const t=function(e){const t="A".charCodeAt(0),M=[],r=parseInt(e.match(/^\d+/)[0],10);e=e.replace(/^\d+/,"");for(let r=0;r<e.length;++r){const n=e[r].charCodeAt(0)-t,l=Math.floor(n/12),i=n%12+1;M.push(...Array(i).fill(l))}return{pixels:M,imageWidth:r}}(n[e].r);Q=t.pixels;const M=function(e,t){const M=[];for(let r=0;r<e.length;r+=t)M.push(e.slice(r,r+t));return M}(t.pixels,t.imageWidth),r=function(e,t,M){console.log(e.length,e[0].length);const r=[],n=e.length,l=e[0].length;for(let i=0;i<n;i+=M)for(let n=0;n<l;n+=t){const l=[];for(let r=0;r<M;r++)l.push(e[i+r].slice(n,n+t));r.push(l)}return r}(M,16,16);return r}function z(e){const t=[];let M=0,r=0,n=0;const l=/([A-Z\-])([xyz]?)(\d*)/g;let i;for(;null!==(i=l.exec(e));){const e=i[1],l=i[2]||"",a=parseInt(i[3]||"1",10),c="-"===e?null:T(e),s=X(l);for(let e=0;e<a;e++){let e=n%(o-2)+1,l=Math.floor(n/(o-2))+1;c&&("key"===c&&t.push({tile:"kH",x:e,y:l,o:s}),t.push({tile:c,x:e,y:l,o:s}),"spawn-current"===c&&(M=e,r=l)),++n}}for(let e=0;e<t.length;e++){const M=t[e];["c","boulder"].includes(M.tile)&&(t.splice(e,1),t.push(M))}return{characterInitialX:M,characterInitialY:r,levelData:t}}function X(e){switch(e){case"x":return 1;case"y":return 2;case"z":return 3;default:return 0}}function T(e){return Object.keys(n)[e.charCodeAt(0)-"A".charCodeAt(0)]}function K(e){let t="",M="",r="",n=0;for(let e=1;e<=a-2;e++)for(let l=1;l<=o-2;l++){const i=re(l,e),o=R(i?.tile),a=U(i?.o);o===M&&a===r?++n:(t+=M+r,n>1&&(t+=`${n}`),M=o,r=a,n=1)}return t+=M+r,n>1&&(t+=`${n}`),t=t.replace(/-[0-9]+$/,""),t}function T(e){return Object.keys(n)[e.charCodeAt(0)-"A".charCodeAt(0)]}function R(e){if(!e)return"-";const t=Object.keys(n).indexOf(e);return String.fromCharCode("A".charCodeAt(0)+t)}function U(e){return{1:"x",2:"y",3:"z"}[e]||""}function V(){p.clearRect(0,0,E.width,E.height),"menu"===b&&function(){it+=.005*ot,(it>.9||it<.6)&&(ot*=-1);const e="#1c0066",t="#01399a",M="#0090cc";Nt(x,E.width,0,E.height/2.5,e,t,it),Nt(x,E.width,E.height/2.5,E.height/2,t,M,it/2),p.drawImage(B,0,0,E.width,E.height);const r=5,n=15,l=4;at=[],nt.forEach(((e,t)=>{const M=n+t*l,i=t===lt;Z.text({ctx:p,x:r*w,y:M*w,scale:1,text:e.text,color:i?"rgb(255,255,0)":e.isDisabled?"rgb(150,150,150)":"rgb(0, 0,0)"}),at.push({x:r-2,y:(M-6)*w,width:80*w,height:16*w,action:e.action,isDisabled:e.isDisabled})}))}(),"editor"===b&&(W(k),$e()),"game"===b&&(W(k),function(){L.fillStyle="#333",L.fillRect(0,0,A.width,A.height),Z.text({ctx:L,x:10,y:7,text:"STEPS:",color:"rgb(255,255,255)"});let e=0,t=0;if(Qe>=10){const M=Qe-9;e=Ye(M),t=Ye(M)}Z.text({ctx:L,x:40+e,y:7+t,text:`${Qe}`,color:Ne(Qe)});const M=n.key.tiles[0],r=n.key.co||["#000","#f00","#0f0","#00f"];ee(M,r,4.5,.2,{context:L}),Z.text({ctx:L,x:120,y:7,text:`LEVEL: ${k+1}`,color:"rgb(255,255,255)"}),Z.text({ctx:L,x:90,y:7,text:`x${m}`,color:"rgb(255,255,255)"}),Z.text({ctx:L,x:270,y:3,text:"E: UNDO",color:"rgb(255,255,255)"}),Z.text({ctx:L,x:270,y:10,text:"R: RESET",color:"rgb(255,255,255)"})}(),function(){const e=n.characters.tiles[ye],t=n.characters.co;ee(e,t,Le,Ee,{scale:ge,flipHorizontally:de===h})}())}function W(e){p.drawImage(B,0,0,E.width,E.height),_(d[e].levelData)}function $(e,t){const M=n[e].tiles[0],r=n[e].co,l=n[t].tiles[0],i=n[t].co;for(let e=0;e<a;e++)for(let t=0;t<o;t++)ee(M,r,t,e),0!==t&&t!==o-1&&0!==e&&e!==a-1||ee(l,i,t,e);"game"===b&&_(d[k].levelData,!0),x.drawImage(E,0,0,B.width,B.height)}function _(e,t=!1){e.forEach((e=>{const M=n[e.tile];if("game"===b&&(t&&!M.iS||!t&&M.iS))return;ee(M.tiles[e.animationFrame||0],e.color||n[e.tile].co,e.x,e.y,{o:e.o||q,scale:e.scale||1})}))}function ee(e,t,M,r,n={}){const{o:i=q,scale:o=e.scale||1,context:a=p,flipHorizontally:c=!1,alpha:s=1}=n;a.save();const Y=l*w/2;a.translate(Math.floor((M+.5)*l*w),Math.floor((r+.5)*l*w));let N=1;c&&(N=-1),a.scale(o*N,o),a.rotate(i*Math.PI/2),a.translate(-Y,-Y);for(let M=0;M<e.length;M++)for(let r=0;r<e[M].length;r++){const n=e[M][r];n>0&&(a.fillStyle=t[n-1],a.globalAlpha=s,a.fillRect(r*w,M*w,w,w))}a.restore()}function te(e){k=e,$("sand","rock"),d[k].initialData=JSON.parse(JSON.stringify(d[k].levelData)),Qe=0,m=0,F=[],Ze=d[k].characterInitialX,Ae=d[k].characterInitialY,Le=Ze,Ee=Ae,Xe(u),ge=1}function Me(e,t){return e>=1&&e<o-1&&t>=1&&t<a-1}function re(e,t,M=[],r=k){let n=null,l=d[r].levelData;for(const r of l)r.x===e&&r.y===t&&(M.length>0?M.includes(r.tile)&&(n=r):n=r);return n}function ne(e=[],t=k){let M=[],r=d[t].levelData;for(const t of r)e.length>0?e.includes(t.tile)&&M.push(t):M.push(t);return M}function le(e,t,M){d[k].levelData=d[k].levelData.filter((r=>r.tile!==e||r.x!==t||r.y!==M))}function ie(e,t,M,r={}){d[k].levelData[r.isUnder?"unshift":"push"]({tile:e,x:t,y:M,...r})}function oe(e,t,M){Be=e,fe=e.x,qe=e.y,he=t,ue=M,xe=0}function ae(e,t,M,r){ce("bT",e,t),ce("block",e,t),Ve("block");const n=e+M,l=t+r,i=re(n,l)?.tile;if("block"===i){const e=d[k].levelData.find((e=>e.x===n&&e.y===l&&"block"===e.tile));if(e){const t=e.o||q;let M=0,r=0;t===g?M=-1:t===h?M=1:t===q?r=-1:t===u&&(r=1),setTimeout((()=>{ae(n,l,M,r)}),120)}}}function ce(e,t=null,M=null,r,n=s){d[k].levelData.filter((r=>r.tile===e&&(null===t||r.x===t&&r.y===M))).forEach((e=>{e.isBeingRemoved=!0,e.scale=1,e.elapsed=0,e.removalDuration=n,e.removeCallback=r}))}function se(){let e=ne("switch-on"),t=ne("switch-off");e.forEach((e=>{e.tile="switch-off"})),t.forEach((e=>{e.tile="switch-on";let t=re(e.x,e.y,["c","boulder"]);t&&ce(t.tile,e.x,e.y)}))}function Ye(e){const t=.5*e;return Math.random()*t-t/2}function Ne(e){return e<11?"rgb(255, 255, 255)":e<12?"rgb(255, 255, 0)":e<13?"rgb(255, 165, 0)":"rgb(255, 0, 0)"}!function(){for(const e in n)n[e].tiles=j(e)}();let fe,qe,he,ue,ge,de,Ze,Ae,Le,Ee,pe,Be=null,xe=0;function Fe(e,t,M,r,n){let l=!1;switch(n?.tile){case"c":case"boulder":(function(e,t,M,r,n){let l=1;"boulder"===e&&(l=o);let i=0;for(;i<l;){let e=t+(i+1)*r,l=M+(i+1)*n,o=re(e,l)?.tile||null;if(!Me(e,l)||null!==o&&!["arrow","h","trap","hF","switch-off","switch-trigger","spikes"].includes(o))break;i++}if(i>0){let l=d[k].levelData;for(const o of l)if(o.x===t&&o.y===M&&o.tile===e){oe(o,t+i*r,M+i*n);for(let t=1;t<i;t++)setTimeout((()=>{Ve(e)}),Y*t);return!0}}return!1})(n?.tile,e,t,M,r)&&(l=!0,be(),re(e,t,["switch-trigger"])&&se());break;case"lock":m>0&&(l=!0,be(),ce("lock",e,t,(()=>{m--})));break;case"trap":be();break;case"bT":const i=n.o||q;(i===g&&-1===M||i===h&&1===M||i===q&&-1===r||i===u&&1===r)&&(l=!0,be(),ae(e,t,M,r));break;case"gong-trigger":n.triggered||(l=!0,be(),n.triggered=!0,ce("gong"))}return l}function be(){F.push({levelData:JSON.parse(JSON.stringify(d[k].levelData)),stepsPerformed:Qe,collectedKeysNumber:m,characterX:Le,characterY:Ee,characterDirection:de})}function we(e){if(console.log("keyup",e,event.key),e){const t=C.indexOf(e);-1!==t&&C.splice(t,1)}"r"===e&&(d[k].levelData=JSON.parse(JSON.stringify(d[k].initialData)),te(k)),"e"===e&&function(){if(F.length>0){const e=F.pop();console.log("Undoing last action:",e),d[k].levelData=e.levelData,Qe=e.stepsPerformed,m=e.collectedKeysNumber,Le=e.characterX,Ee=e.characterY,Xe(e.characterDirection)}}(),Ue=!1}function me(e){switch(e){case"ArrowUp":case"z":case"w":return"up";case"ArrowDown":case"s":return"down";case"ArrowLeft":case"q":case"a":return"left";case"ArrowRight":case"d":return"right";default:return e}}let ye,Ce,ke,Oe,ve,De,Ge,He,Pe=Le,Je=Ee,Ie=Le,Se=Ee,Qe=0;function je(e,t,M){if(ke||pe||Be)return;const r=Le+e,n=Ee+t;Xe(M),function(e,t,M=0,r=0){if(Be||pe||ke)return!1;if(!Me(e,t))return Ve("wall"),!1;const n=re(e,t),l=n?.tile||null;if(n&&n.isBeingRemoved)return!1;K(d[k].levelData);let i=Fe(e,t,M,r,n);return i&&Ve(l),!![null,"arrow","key","kH","f","trap","h","spikes","hF","spawn","spawn-current","switch-trigger","switch-off"].includes(l)||(i?(++Qe,Ue=!0,Ke(Le,Ee,i)):Ve("wall"),!1)}(r,n,e,t)&&(Qe<i&&(pe=!0,Pe=Le,Je=Ee,Ie=r,Se=n,Ce=0),Qe=Math.min(Qe+1,i))}function ze(e=null,t=null){ke=!0,ve=Le,De=Ee,Ge=e||Ze,He=t||Ae,Oe=performance.now()}function Xe(e){de=e,ye=Te(de)}function Te(e){switch(e){case q:return 2;case h:case g:return 1;case u:return 0}}function Ke(e,M,r){const n=re(e,M,["trap","switch-trigger"]),l=re(Le,Ee);switch(n?.tile){case"trap":r||"h"===l?.tile||(Ve("trap"),n.tile="h");break;case"switch-trigger":se()}switch(l?.tile){case"h":case"spikes":ze(e,M),--Qe;break;case"f":return t("currentLevel",k+1),te(k+1),!1;case"spawn-current":Qe=0;break;case"spawn":re(Ze,Ae).tile="spawn",l.tile="spawn-current",l.animationFrame=0,l.elapsed=0,Ze=Le,Ae=Ee,Qe=0;break;case"switch-trigger":se();break;case"key":le("key",Le,Ee),Ve("key"),++m}Qe>=i&&(ze(),setTimeout((()=>{Qe=0}),f))}function Re(e){!function(e){if(d[k].levelData.forEach((t=>{if(n[t.tile].tiles.length>1){t.elapsed=(t.elapsed||0)+e;const M=c[t.tile];t.elapsed>=M&&(t.animationFrame=(t.animationFrame+1)%n[t.tile].tiles.length||0,t.elapsed=0)}if(t.isBeingRemoved){t.elapsed=(t.elapsed||0)+e;const M=t.removalDuration||s;t.scale=Math.max(1-t.elapsed/M,0),t.scale<=0&&(le(t.tile,t.x,t.y),t.removeCallback&&t.removeCallback())}})),!pe&&!ke&&C.length>0){switch(C[C.length-1]){case"up":je(0,-1,q);break;case"down":je(0,1,u);break;case"left":je(-1,0,g);break;case"right":je(1,0,h)}}pe&&function(e){Ce+=e;const t=Math.min(Ce/N,1);Le=Pe+(Ie-Pe)*t,Ee=Je+(Se-Je)*t;let M=Te(de);switch(Math.floor(3*t)){case 0:ye=M+3;break;case 1:ye=M;break;case 2:ye=M+6}t>=1&&(pe=!1,Le=Ie,Ee=Se,Ce=0,ye=M,Ke(Pe,Je))}(e);Be&&function(e){xe+=e;const t=Math.abs(fe-he)+Math.abs(qe-ue);let M=Y*t;const r=Math.min(xe/M,1);if("boulder"===Be.tile){const e=4,M=t*e,n=Math.floor(r*M)%e;Be.o=n}Be.x=fe+(he-fe)*r,Be.y=qe+(ue-qe)*r,r>=1&&(Be.x=he,Be.y=ue,xe=0,"c"===Be.tile&&function(e){const t=re(e.x,e.y,["h","trap"]);t&&(le(t.tile,e.x,e.y),le("c",e.x,e.y),ie("hF",e.x,e.y,{isUnder:!0}),Ve("fall"))}(Be),["c","boulder"].includes(Be.tile)&&re(Be.x,Be.y,["switch-trigger"])&&se(),Be=null)}(e)}(e-y),ke&&function(){const e=performance.now()-Oe,t=Math.min(e/f,1);t<.5?(ge=1-2*t,Le=ve,Ee=De):(ge=2*(t-.5),Le=Ge,Ee=He,Ge===Ze&&He===Ae&&Xe(u));t>=1&&(ke=!1,Le=Ge,Ee=He,ge=1)}(),V(),y=e,requestAnimationFrame(Re)}window.addEventListener("keydown",(e=>{const t=me(e.key);"game"===b&&function(e){e&&!C.includes(e)&&C.push(e)}(t),"menu"===b&&function(e,t){switch(e){case"up":lt=(lt-1+nt.length)%nt.length,nt[lt].isDisabled&&(lt=(lt-1+nt.length)%nt.length);break;case"down":lt=(lt+1)%nt.length,nt[lt].isDisabled&&(lt=(lt+1)%nt.length)}if("Enter"===t.key){const e=nt[lt];e.isDisabled||ct(e.action)}}(t,e),"Escape"===e.key&&Mt("menu")})),window.addEventListener("keyup",(e=>{const t=me(e.key);"game"===b&&we(t)})),E.addEventListener("mousemove",(e=>{e.preventDefault();const t=E.getBoundingClientRect(),M=e.clientX-t.left,r=e.clientY-t.top;"menu"===b&&at.forEach(((e,t)=>{M>=e.x&&M<=e.x+e.width&&r>=e.y&&r<=e.y+e.height&&(e.isDisabled||(lt=t))})),"editor"===b&&(D.x=Math.floor(M/(l*w)),D.y=Math.floor(r/(l*w)),$e(),We&&_e(e))})),E.addEventListener("mouseleave",(e=>{e.preventDefault(),"editor"===b&&(D.x=-1,D.y=-1,$e())})),E.addEventListener("mousewheel",(e=>{if(e.preventDefault(),"editor"===b){const t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));v.value=(parseInt(v.value)+t+4)%4,$e()}})),E.addEventListener("mousedown",(e=>{We=!0,"editor"===b&&_e(e)})),E.addEventListener("click",(e=>{"menu"===b&&function(e){const t=E.getBoundingClientRect(),M=e.clientX-t.left,r=e.clientY-t.top;at.forEach((e=>{M>=e.x&&M<=e.x+e.width&&r>=e.y&&r<=e.y+e.height&&(e.isDisabled||ct(e.action))}))}(e)})),window.addEventListener("mouseup",(e=>{We=!1}));let Ue=!1;function Ve(e){switch(e){case"gong-trigger":G(...[,0,523.2511,.02,,1.5,1,.5,-.05,.5,,,.3,.05,,,.05,.8,,.05]);break;case"block":G(...[,0,146.8324,.1,,0,,,,,,,,4,,,,0,.2]);break;case"boulder":G(...[,0,73.41619,.1,,0,,,,,,,,4,,,,0,.2]);break;case"c":G(...[,0,146.8324,.05,,.05,,1.3,,,,,,3]);break;case"key":G(...[,0,1320,,.06,.3,1,,,,880,.06]);break;case"lock":G(...[,0,440,.1,,,1,.3,,,-110,.15,,,,,,,.1]);break;case"trap":G(...[.5,0,440,.08,,.2,4,2,,,,,,5]);break;case"wall":Ue||(Ue=!0,G(...[,0,440,.15,.01,.12,1,1.59,-6.98,4.97]))}}let We=!1;function $e(){const e=O.value,t=parseInt(v.value);ee(n[e].tiles[0],n[e].co,D.x,D.y,{o:n[e].cCO?t:q,scale:1,flipHorizontally:!1,alpha:.5})}function _e(e){if(1===e.buttons){if(!re(D.x,D.y)&&Me(D.x,D.y)){ie(O.value,D.x,D.y,{o:n[O.value].cCO?parseInt(v.value):q});K(d[k].levelData)}}else if(2===e.buttons){le(O.value,D.x,D.y);K(d[k].levelData)}}e("#editorTestLevelButton").addEventListener("click",(()=>{if(!function(){let e=d[k].levelData,t=0,M=0;e.forEach((e=>{"spawn-current"===e.tile?t++:"f"===e.tile&&M++}));let r="",n=1===t&&1===M;n||(1!==t&&(r+="There must be exactly one player spawn point.\n"),1!==M&&(r+="There must be exactly one f.\n"));return et.textContent=r,n}())return;let e=K(d[k].levelData);window.open(`./index.html?level=${e}`)}));let et=e("#editorMessage");function tt(){w=Math.min(Math.floor(window.innerWidth/(o*l)),Math.floor(.89*window.innerHeight/(a*l))),E.width=o*l*w,E.height=a*l*w,A.width=E.width,A.height=1.1*l*w,window.innerWidth/window.innerHeight>o/a?(B.width=window.innerWidth,B.height=window.innerWidth*(a/o)):(B.height=window.innerHeight,B.width=window.innerHeight*(o/a))}function Mt(e){document.body.classList.remove(b),document.body.classList.add(e),b=e,"game"===b&&(t("currentLevel",k),te(k)),"editor"===b&&(k=0,te(k),Object.keys(n).forEach((e=>{if(0!==n[e].limit){let t=document.createElement("option");t.value=e,t.text=e,O.appendChild(t)}})))}window.addEventListener("resize",(()=>{tt(),$("sand","rock")})),function(){p.imageSmoothingEnabled=!1,tt();const e=new URLSearchParams(window.location.search).get("level");if(e){let t=z(e);console.log(t),t&&(d.push(t),k=d.length-1,console.log(k,d),Mt("game"))}else Mt(b);requestAnimationFrame(Re)}();let rt=null!==M("currentLevel");const nt=[{text:"CONTINUE",action:"continue",isDisabled:!rt},{text:"NEW GAME",action:"newGame",isDisabled:!1},{text:"LEVEL EDITOR",action:"levelEditor",isDisabled:!1}];let lt=rt?0:1,it=.6,ot=1,at=[];function ct(e){switch(e){case"continue":k=parseInt(M("currentLevel")),Mt("game");break;case"newGame":Mt("game");break;case"levelEditor":Mt("editor")}}const st=[[-.5,0,-.375,.125],[.25,-.25,.375,-.125],[-.3125,.1875,-.4375,.0625],[.4375,-.0625,.3125,-.1875]],Yt=4;function Nt(e,t,M,r,n,l,i=.25){for(let o=0;o<r;o++){const a=o*w/r;for(let r=0;r<t;r++){const t=a+st[o%Yt][r%Yt]*i<.5?n:l;e.fillStyle=t,e.fillRect(r*w,M+o*w,w,w)}}}}();</script></div></body></html>