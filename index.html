<html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>13 steps to death</title><style>body,
      html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
        width: 100%;
      }

      body:not(.game) {
        .-game {
          display: none;
        }
      }
      body:not(.editor) {
        .-editor {
          display: none;
        }
      }

      #game {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #gBC {
        position: absolute;
        top: -5%;
        left: -5%;
        width: 110%;
        height: 110%;
        z-index: -1;
        object-fit: cover;
        filter: blur(15px) brightness(50%);
      }</style></head><body oncontextmenu="return!1"><div id="game"><canvas id="gBC"></canvas><canvas id="uiCanvas" class="-game"></canvas><div id="editor" class="-editor"><div id="editorUi"><label>Tile: <select id="eTS"></select></label> <label>Orientation: <select id="eOS"><option value="0">Up</option><option value="1">Right</option><option value="2">Down</option><option value="3">Left</option></select></label> <button id="editorTestLevelButton">Test level</button><p id="editorMessage"></p></div></div><canvas id="gC"></canvas><script>!function(){"use strict";let e=e=>document.querySelector(e),t=(e,t)=>localStorage.setItem(e,t),M=e=>localStorage.getItem(e),r=Math.min,n=Math.max;const l={bG:["#024d53","#599dbc","#72d1c7","#a9ffe6"],crate:["#000","#893a25","#f89e61","#c16c43"],g:["#000","#527f67","#a2ce69","#d6f8e1"],s:["#e5d09e","#cab168"],br:["#000","#811c07","#ca6137","#ffb59c"],p:["#341b2e","#6a5979","#937cb2","#afbeff"]},i={arrow:{r:"16LKZLA\\K^LZLBZLBZLLLLLLLLLLLLG",co:l.bG,limit:0,iS:!0},block:{r:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",co:l.bG,cCO:!0},"block-trigger":{r:"16AXNAMYezeYNZnZNedeNqeYlYeqNqeYgNgYeqNqeYfMeYMfYeqNqeYfMeYMfYeqNqeYeMfZMeYeqNqeYeMeNYMeYeqNqeYeNfNeYeqNqeYlYeqNedeNZnZNYezeYMAXNA",co:l.g,cCO:!0},boulder:{r:"16LIRHNgqYqNEMgsZrMCMfrYrZsMBMesYqZtMAMfYrYq^qNfZqZuZNerYrYvYN]q[tYNtYs^MAMs[uYMBM\\q[q[MCMtYq\\MENs[NHRE",co:l.crate},crate:{r:"16AXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYO[MZM]OYNYMYNYPYNYMZMYNYMZMYNYPYNYMYNYO]MZM[NAXNA",co:l.crate},flag:{r:"48DYLCYLCYLBZLBZLBZLCMgLMlGMlGMkHMkHMkHMkHMkHMkHMkHMkHMkHMkHMlGMkHMFfGMLCMChHMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLCMLBZLBZLBZK",co:l.br,limit:1},"gong-trigger":{r:"16XQsevesNqfTfqNfOhNgNfNeteNfNfMeqPqeMfMAMeMeqMrMqeMeMBMeMeqPqeMeMBMeNeteNeMBMeMAMhMAMeMBMeMBPBMeMBMeMHMeMBMeMHMeMBMeMAQBMeMBMeMBQAMeMBOHOA",co:l.br,iS:!0},gong:{r:"16F\\JZtZGYfvYEZe^rYC\\jYrYB[lYqYBZnZBYhthYBYgq\\qgYBYgqYrYqgYBYgq\\qgYBZgtgZBeZlZeCeZjZeEe`eGlD",co:l.br},"hole-filled":{r:"16LLLAMANAMFXNANYnYOZVZNeNeqjNeNeMfqetfMeNeMfteqfMeNeNjqeNeNZVZOYnYOYXYMAM[MZM]MCMAYMYNYNAMLF",co:l.crate},hole:{r:"16LLLYA\\AYGbEYA`AYDdCYAbAYB\\MYNYM\\A\\MYMZMYM\\AZMYMYNYMYMZCZTZCZMYRYMZCZTZEYTYHRLI",co:["#000","#00506e"]},"key-holder":{r:"16LFdCYpYAZ{e\\qbe\\qYeYhYeYe\\qZfZfZe\\qYgZgYe\\qYgYhYe\\qZfZfZe\\qYeYhYeYe\\qbe\\oq[edqZpfYAdZA",co:l.bG,limit:0,iS:!0},key:{r:"16FtKqPqIqMhMqHqMYNeMqHqMYNeMqHqM\\MqIqNYMqJqMeYMqJqNYMqJqMZMqKqNqLArLLLLLK",co:l.g},lock:{r:"16FPKMtMIMq\\qMGMZhYqMEMZeqNYeYqMCNYeqPYeYqMAOYeqPYeYrPYfqNYfYrO[eqNYeYfqMYM\\ereYgMYAYM\\fYgMYCYM[MYgMYEYMYMfYeMYGYMhMYIYPYK\\F",co:l.g},rock:{r:"16FPIOhNFMeresfMDMerYeueMCMfqZesfqMBMgqZgYfMBMiYgZNBNYkZqNBNYiZsMBMqgriqMAMqeqYgqMYgMAMYfqMYeqMYgMAMZeqMYfNYfMAOZNYPYMqBPEOLF",co:l.bG,iS:!0},"spawn-current":{r:"16E\\LBYAYJZBYAYJZAYAYJYAYBYBYD[F[AYAYEZCYBZAZB\\AYB\\BYA\\BZAZBYCZEYAYA[F[DYBYBYAYJYAYAZJYAYBZJYAYLB\\E",co:l.bG,limit:1},spawn:{r:"32E\\L\\LBYAYLAYAYJZBYAYIZBYAYJZAYAYJZAYAYJYAYBYBYGYAYBYBYD[F[AYB[F[AYAYEfCYBYAYErCYBZAZBhAYB[AZBtAYB\\BYAhBZA[BYAtBZAZBYCfEYAYBYCrEYAYA[F[BYA[F[DYBYBYAYGYBYBYAYJYAYAZJYAYAZJYAYBZIYAYBZJYAYLAYAYLB\\L\\E",co:l.bG},trap:{r:"16DNANANGVEQfQCNYM[N[NBMeMfYfMfMeMANZM\\e\\OeMfMYgMfMeO]N]OgNgMeYgN\\eYM]eYOeMeOgYfNAeZN[M[MeBNYeMgMfOCO[fZNFQfMJPF",co:["#306710","#000","#b1712e"]},s:{r:"16ZMYV]MYV]MYW\\MYMYU^MYU^MZU^MZV]MYV]XM\\XM\\X[XN[XM\\X]XZ",co:l.s,limit:0},characters:{r:"144FPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFMlMGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMesereMEMeugMFMlMFMlMEMmMFMlMFMlMEMmMFMlMEMqeveqMEMufNEMqlqMEMereseMEMeugMFMlMFMereseMEMeugMFMlMFMrMrMrMFMqMseMqMFMlMEMqeveqMEMufNEMqlqMDMqeveqMEMufNEMqlqMFMqMrMqMGMqMuMHMjMGMrMrMrMFMqMseMqMFMlMFMrMrMrMFMqMseMqMFMlMFOtOGMtNHOtOFNqMrMqNFMqMuMHNhNGNqMrMqNFMqMuMHNhNFM[P[MGPYMGM[P[MDMZMtMZMFMtNHMZPZMEMZMtMZMFMtOGMZPZMDMZMZrZMZMFN[MFMZM^MZMCOYPYMYqMEQYNFMqM^OCMqYMYPYOFQ[MEO^MqMCMZM^MZMFMYMZMFMZM^MZMCMrM]NqMDMr\\MqMFN]MrMCMqN]MrMEMqNZMYqMEMrM]NEMqTqMGMYMqNGMqTqMEUANEO\\MHUDNAUGN\\MqMFUGN^NHOqMIN^NHMqNZMISHMZNqMIMZNqMJSIMqNZMHMrNrMIMrNJMrNrMJOrMHMrNrMHMrOJMrOJMrNrMJOrMJPKQLPLLLLLLLLJNhNGNiNHNhNJPKQLPLPKQLPIMlMEMmMFNjNGNhNGNiNHNhNHNhNGNiNHNhNGMlMEMmMFMlMFMlMEMmMFNjNFMlMEMmMFNjNFMgqhMEMmMFMlMFMlMEMmMFMlMFMlMEMmMFMlMFMeveMEMerjMFMlMFMgqhMEMmMFMlMFMgqhMEMmMFMlMEMqeveqMEMshMeMDMqlqMEMeveMEMerjMFMlMFMeveMEMerjMFMlMFMeqMrMqeMFMqMqgMqMeMDMgNgMEMqeveqMEMshMeMDMqlqMDMqeveqMEMshMeMDMqlqMFMqMrMqMGMqMqfrMfMEMeMfMeMGMeqMrMqeMFMqMqgMqMeMDMgNgMFMeqMrMqeMFMqMqgMqMeMDMgNgMGNtNHMtNfMFNhNHMqMrMqMGMqMqfrMfMEMeMfMeMHMqMrMqMGMqMqfrMfMEMeMfMeMGMZPZMHSeMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFMYMtMYMGMtNfMEMYMhMYMFM[r[MGMYNYMANFMZMfMZMFMYQYNHSfMDMYMgPFNYQYMGTfMDMYNgOEMqN\\NqMFMZMqMHMqNYNYNqMEO\\MrMFMZqNqODMrNeQEMrM\\OGM[MrOEQeNrMCMrN\\NrMFMYMqMGMrN\\NrMCMrM\\PFMsPFPYNYMrMDP\\MrMEMqMZNqMFMrMYNYPDOrNrOGMrNHOrNrOEOqNrMIOYqMIMrNqOGMrNqOGMrNYNGOqNrMIMqNqMKMqMLMqNqMKOqMJMqNqMJMqOKMqOJMqOqMKOqME",co:["#000","#e42c37","#c07548","#fdcbb0"],limit:0},spikes:{r:"16LEpeBe|qeA|sArgqgqgrAreMeqeMeqeMerArgqgqgrA|sArgqgqgrAreMeqeMeqeMerArgqgqgrA|sArgqgqgrAreMeqeMeqeMerArgqgqgrB|qB",co:l.bG},"switch-off":{r:"16LLIpfBedeBeZxZeBeYzYeBeYs\\sYeBeYs\\sYeBeYs\\sYeBeYzYeBeYzYeBeZxZeBedeBpfLLI",co:l.p},"switch-on":{r:"16CVEMexeMDMqftfqMCeMqeqPqeqMeBeMqeqPqeqMeBeMqeqPqeqMeBeMqftfqMeBeMexeMeBeNlNeBeMqZereZqMeBeMeqZfZqeMeBeMYerfreYMeBeNYe\\eYNeBeXeBiDiLE",co:l.p},"switch-trigger":{r:"16Zp[pfYplTkMxMjMxMjMrPrMjMrPrMjMrPrMjMxMjMxMjM`MjYTYk`hYpf[pZ",co:l.p}},a=16,o=13,c=20,s=10,Y={flag:200,spawn:600},N=225,f=125,q=300,h=400,u=0,g=1,d=2,Z=3,A=[];["","-6N-F-N-13N-3N-7N7Bz2CzMN7-2GAz-N2-6NLN-2N4-2N-6NHN-6E2-17A-2O","-2N-3N5-9N-E-J-MCxBx2By-7N-3N5-By-7N-N-N5-N-5N3-E-P-2JE-N-5LJ2-E-N5-N-5N11HN-2F-2G-5Q5ON","-6NGN-5EQN2-6N-N-5N-N2-4F-M-M-2O-2Cz-CzL-6N-N-2E-2N-NQ-6N5CN3-NQ-8N-7NQ-8N3JN5Q-8NL-4HQ2P","-7Bz8N-9NEN5CN-6O-2Q-Q-4H-6E-3Q-Q-5P-5W-3NTN7MN-7V-2WN-6N3VN4UN3-3F-2N3GN4L-N2"].forEach((e=>{const t=R(e);A.push(t)}));const E={1:"010110010010111",2:"01101001001001001111",3:"11100001001100011110",4:"00110101100111110001",5:"11111000111100011110",6:"01101000111010010110",7:"11110001001000100010",8:"01101001011010010110",9:"01101001011100010110",0:"01101001100110010110",A:"01101001111110011001",C:"011100100100011",D:"110101101101110",E:"111100111100111",G:"01111000101110010110",I:"111010010010111",L:"100100100100111",M:"1000111011101011000110001",N:"10011101101110011001",O:"01101001100110010110",P:"11101001111010001000",R:"11101001111010101001",S:"01111000011000011110",T:"111010010010010",U:"10011001100110010110",V:"1000110001010100101000100",W:"1010110101101010101001010"," ":"000000000000000",":":"000010000010000",x:"000000101010101"};function L(e){let t=0;for(let M=0;M<e.text.length;M++){const r=e.text.charAt(M),n=E[r],l=n.length/5;for(let r=0;r<5;r++)for(let i=0;i<l;i++){"1"===n[r*l+i]&&e.ctx.rect((e.x+(i+t+e.hspacing*M))*k,(e.y+r)*k,k,k)}t+=l}}function p(e){const t={ctx:x,x:0,y:0,text:"",vspacing:1,hspacing:1,color:"#fff",...e},M=t.text.split("\n"),r=5*k;t.ctx.beginPath();for(let e=0;e<M.length;e++){const n=M[e],l=t.x,i=t.y+(r+t.vspacing*k)*e;L({ctx:t.ctx,x:l,y:i,text:n,hspacing:t.hspacing})}t.ctx.fillStyle=t.color,t.ctx.fill()}const B=e("#uiCanvas"),F=B.getContext("2d"),w=e("#gC"),x=w.getContext("2d"),b=e("#gBC"),m=b.getContext("2d");let C,y="menu",k=1,O=0,v=0;const D=[];let G=1,H=e("#eTS"),P=e("#eOS"),J={x:-1,y:-1},I=(...e)=>S(Q(...e)),S=(...e)=>{let t=X.createBufferSource(),M=X.createBuffer(e.length,e[0].length,z);return e.map(((e,t)=>M.getChannelData(t).set(e))),t.buffer=M,t.connect(X.destination),t.start(),t},Q=(e=1,t=.05,M=220,l=0,i=0,a=.1,o=0,c=1,s=0,Y=0,N=0,f=0,q=0,h=0,u=0,g=0,d=0,Z=1,A=0,E=0)=>{let L,p,B=2*Math.PI,F=s*=500*B/z**2,w=(0<u?1:-1)*B/4,x=M*=(1+2*t*Math.random()-t)*B/z,b=[],m=0,C=0,y=0,k=1,O=0,v=0,D=0;for(Y*=500*B/z**3,u*=B/z,N*=B/z,f*=z,q=z*q|0,p=(l=99+z*l)+(A*=z)+(i*=z)+(a*=z)+(d*=z)|0;y<p;b[y++]=D)++v%(100*g|0)||(D=o?1<o?2<o?3<o?Math.sin((m%B)**3):n(r(Math.tan(m),1),-1):1-(2*m/B%2+2)%2:1-4*Math.abs(Math.round(m/B)-m/B):Math.sin(m),D=(q?1-E+E*Math.sin(2*Math.PI*y/q):1)*(0<D?1:-1)*Math.abs(D)**c*e*j*(y<l?y/l:y<l+A?1-(y-l)/A*(1-Z):y<l+A+i?Z:y<p-d?(p-y-d)/a*Z:0),D=d?D/2+(d>y?0:(y<p-d?1:(p-y)/d)*b[y-d|0]/2):D),L=(M+=s+=Y)*Math.sin(C*u-w),m+=L-L*h*(1-1e9*(Math.sin(y)+1)%2),C+=L-L*h*(1-1e9*(Math.sin(y)**2+1)%2),k&&++k>f&&(M+=N,x+=N,k=0),!q||++O%q||(M=x,s=F,k=k||1);return b},j=.3,z=44100,X=new(window.AudioContext||webkitAudioContext),T=[];function K(e){const t=function(e){const t="A".charCodeAt(0),M=[],r=parseInt(e.match(/^\d+/)[0],10);e=e.replace(/^\d+/,"");for(let r=0;r<e.length;++r){const n=e[r].charCodeAt(0)-t,l=Math.floor(n/12),i=n%12+1;M.push(...Array(i).fill(l))}return{pixels:M,imageWidth:r}}(i[e].r);T=t.pixels;const M=function(e,t){const M=[];for(let r=0;r<e.length;r+=t)M.push(e.slice(r,r+t));return M}(t.pixels,t.imageWidth),r=function(e,t,M){const r=[],n=e.length,l=e[0].length;for(let i=0;i<n;i+=M)for(let n=0;n<l;n+=t){const l=[];for(let r=0;r<M;r++)l.push(e[i+r].slice(n,n+t));r.push(l)}return r}(M,16,16);return r}function R(e){const t=[];let M=0,r=0,n=0;const l=/([A-Z\-])([xyz]?)(\d*)/g;let i;for(;null!==(i=l.exec(e));){const e=i[1],l=i[2]||"",a=parseInt(i[3]||"1",10),o="-"===e?null:V(e),s=U(l);for(let e=0;e<a;e++){let e=n%(c-2)+1,l=Math.floor(n/(c-2))+1;o&&("key"===o&&t.push({tile:"key-holder",x:e,y:l,o:s}),t.push({tile:o,x:e,y:l,o:s}),"spawn-current"===o&&(M=e,r=l)),++n}}for(let e=0;e<t.length;e++){const M=t[e];["crate","boulder"].includes(M.tile)&&(t.splice(e,1),t.push(M))}return{characterInitialX:M,characterInitialY:r,levelData:t}}function U(e){switch(e){case"x":return 1;case"y":return 2;case"z":return 3;default:return 0}}function V(e){return Object.keys(i)[e.charCodeAt(0)-"A".charCodeAt(0)]}function W(e){let t="",M="",r="",n=0;for(let e=1;e<=s-2;e++)for(let l=1;l<=c-2;l++){const i=ae(l,e),a=$(i?.tile),o=_(i?.o);a===M&&o===r?++n:(t+=M+r,n>1&&(t+=`${n}`),M=a,r=o,n=1)}return t+=M+r,n>1&&(t+=`${n}`),t=t.replace(/-[0-9]+$/,""),t}function V(e){return Object.keys(i)[e.charCodeAt(0)-"A".charCodeAt(0)]}function $(e){if(!e)return"-";const t=Object.keys(i).indexOf(e);return String.fromCharCode("A".charCodeAt(0)+t)}function _(e){return{1:"x",2:"y",3:"z"}[e]||""}function ee(){x.clearRect(0,0,w.width,w.height),"menu"===y&&function(){st+=.005*Yt,(st>.9||st<.6)&&(Yt*=-1);const e="#1c0066",t="#01399a",M="#0090cc";ut(m,w.width,0,w.height/2.5,e,t,st),ut(m,w.width,w.height/2.5,w.height/2,t,M,st/2),x.drawImage(b,0,0,w.width,w.height);const r=5,n=15,l=4;Nt=[],ot.forEach(((e,t)=>{const M=n+t*l,i=t===ct;p({ctx:x,x:r*k,y:M*k,scale:2,text:e.text,color:i?"#ff0":e.isDisabled?"#999":"#000"}),Nt.push({x:r-2,y:(M-6)*k,width:80*k,height:16*k,action:e.action,isDisabled:e.isDisabled})}))}(),"editor"===y&&(te(G),Mt()),"game"===y&&(te(G),function(){F.fillStyle="#333",F.fillRect(0,0,B.width,B.height),p({ctx:F,x:10,y:7,text:"STEPS:"});let e=0,t=0;if(Te>=10){const M=Te-9;e=he(M),t=he(M)}p({ctx:F,x:40+e,y:7+t,text:`${Te}`,color:ue(Te)});const M=i.key.tiles[0],r=i.key.co||["#000","#f00","#0f0","#00f"];ne(M,r,4.5,.2,{context:F}),p({ctx:F,x:120,y:7,text:`LEVEL: ${G}`}),p({ctx:F,x:90,y:7,text:`x${O}`}),p({ctx:F,x:270,y:3,text:"E: UNDO"}),p({ctx:F,x:270,y:10,text:"R: RESET"})}(),function(){const e=i.characters.tiles[ve],t=i.characters.co;ne(e,t,Fe,we,{scale:Ee,flipHorizontally:Le===g})}())}function te(e){x.drawImage(b,0,0,w.width,w.height),re(A[e].levelData)}function Me(e,t){const M=i[e].tiles[0],r=i[e].co,n=i[t].tiles[0],l=i[t].co;for(let e=0;e<s;e++)for(let t=0;t<c;t++)ne(M,r,t,e),0!==t&&t!==c-1&&0!==e&&e!==s-1||ne(n,l,t,e);"game"===y&&re(A[G].levelData,!0),m.drawImage(w,0,0,b.width,b.height)}function re(e,t=!1){e.forEach((e=>{const M=i[e.tile];if("game"===y&&(t&&!M.iS||!t&&M.iS))return;ne(M.tiles[e.animationFrame||0],e.color||i[e.tile].co,e.x,e.y,{o:e.o||u,scale:e.scale||1})}))}function ne(e,t,M,r,n={}){const{o:l=u,scale:i=e.scale||1,context:o=x,flipHorizontally:c=!1,alpha:s=1}=n;o.save();const Y=a*k/2;o.translate(Math.floor((M+.5)*a*k),Math.floor((r+.5)*a*k));let N=1;c&&(N=-1),o.scale(i*N,i),o.rotate(l*Math.PI/2),o.translate(-Y,-Y);for(let M=0;M<e.length;M++)for(let r=0;r<e[M].length;r++){const n=e[M][r];n>0&&(o.fillStyle=t[n-1],o.globalAlpha=s,o.fillRect(r*k,M*k,k,k))}o.restore()}function le(e){G=e,Me("s","rock"),A[G].initialData=JSON.parse(JSON.stringify(A[G].levelData)),Te=0,O=0,C=[],pe=A[G].characterInitialX,Be=A[G].characterInitialY,Fe=pe,we=Be,Ue(d),Ee=1}function ie(e,t){return e>=1&&e<c-1&&t>=1&&t<s-1}function ae(e,t,M=[],r=G){let n=null,l=A[r].levelData;for(const r of l)r.x===e&&r.y===t&&(M.length>0?M.includes(r.tile)&&(n=r):n=r);return n}function oe(e=[],t=G){let M=[],r=A[t].levelData;for(const t of r)e.length>0?e.includes(t.tile)&&M.push(t):M.push(t);return M}function ce(e,t,M){A[G].levelData=A[G].levelData.filter((r=>r.tile!==e||r.x!==t||r.y!==M))}function se(e,t,M,r={}){A[G].levelData[r.isUnder?"unshift":"push"]({tile:e,x:t,y:M,...r})}function Ye(e,t,M){be=e,ge=e.x,de=e.y,Ze=t,Ae=M,me=0}function Ne(e,t,M,r){fe("block-trigger",e,t),fe("block",e,t),et("block");const n=e+M,l=t+r,i=ae(n,l)?.tile;if("block"===i){const e=A[G].levelData.find((e=>e.x===n&&e.y===l&&"block"===e.tile));if(e){const t=e.o||u;let M=0,r=0;t===Z?M=-1:t===g?M=1:t===u?r=-1:t===d&&(r=1),setTimeout((()=>{Ne(n,l,M,r)}),120)}}}function fe(e,t=null,M=null,r,n=N){A[G].levelData.filter((r=>r.tile===e&&(null===t||r.x===t&&r.y===M))).forEach((e=>{e.isBeingRemoved=!0,e.scale=1,e.elapsed=0,e.removalDuration=n,e.removeCallback=r}))}function qe(){let e=oe("switch-on"),t=oe("switch-off");e.forEach((e=>{e.tile="switch-off"})),t.forEach((e=>{e.tile="switch-on";let t=ae(e.x,e.y,["crate","boulder"]);t&&fe(t.tile,e.x,e.y)}))}function he(e){const t=.5*e;return Math.random()*t-t/2}function ue(e){return e<11?"rgb(255, 255, 255)":e<12?"rgb(255, 255, 0)":e<13?"rgb(255, 165, 0)":"rgb(255, 0, 0)"}!function(){for(const e in i)i[e].tiles=K(e)}();let ge,de,Ze,Ae,Ee,Le,pe,Be,Fe,we,xe,be=null,me=0;function Ce(e,t,M,r,n){let l=!1;switch(n?.tile){case"crate":case"boulder":(function(e,t,M,r,n){let l=1;"boulder"===e&&(l=c);let i=0;for(;i<l;){let e=t+(i+1)*r,l=M+(i+1)*n,a=ae(e,l)?.tile||null;if(!ie(e,l)||null!==a&&!["arrow","hole","trap","hole-filled","switch-off","switch-trigger","spikes"].includes(a))break;i++}if(i>0){let l=A[G].levelData;for(const a of l)if(a.x===t&&a.y===M&&a.tile===e){Ye(a,t+i*r,M+i*n);for(let t=1;t<i;t++)setTimeout((()=>{et(e)}),f*t);return!0}}return!1})(n?.tile,e,t,M,r)&&(l=!0,ye(),ae(e,t,["switch-trigger"])&&qe());break;case"lock":O>0&&(l=!0,ye(),fe("lock",e,t,(()=>{O--})));break;case"trap":ye();break;case"block-trigger":const i=n.o||u;(i===Z&&-1===M||i===g&&1===M||i===u&&-1===r||i===d&&1===r)&&(l=!0,ye(),Ne(e,t,M,r));break;case"gong-trigger":n.triggered||(l=!0,ye(),n.triggered=!0,fe("gong"))}return l}function ye(){C.push({levelData:JSON.parse(JSON.stringify(A[G].levelData)),stepsPerformed:Te,collectedKeysNumber:O,characterX:Fe,characterY:we,characterDirection:Le})}function ke(e){if(e){const t=D.indexOf(e);-1!==t&&D.splice(t,1)}"r"===e&&(A[G].levelData=JSON.parse(JSON.stringify(A[G].initialData)),le(G)),"e"===e&&function(){if(C.length>0){const e=C.pop();A[G].levelData=e.levelData,Te=e.stepsPerformed,O=e.collectedKeysNumber,Fe=e.characterX,we=e.characterY,Ue(e.characterDirection)}}(),_e=!1}function Oe(e){switch(e){case"ArrowUp":case"z":case"w":return"up";case"ArrowDown":case"s":return"down";case"ArrowLeft":case"q":case"a":return"left";case"ArrowRight":case"d":return"right";default:return e}}let ve,De,Ge,He,Pe,Je,Ie,Se,Qe=Fe,je=we,ze=Fe,Xe=we,Te=0;function Ke(e,t,M){if(Ge||xe||be)return;const n=Fe+e,l=we+t;Ue(M),function(e,t,M=0,r=0){if(be||xe||Ge)return!1;if(!ie(e,t))return et("wall"),!1;const n=ae(e,t),l=n?.tile||null;if(n&&n.isBeingRemoved)return!1;W(A[G].levelData);let i=Ce(e,t,M,r,n);return i&&et(l),!![null,"arrow","key","key-holder","flag","trap","hole","spikes","hole-filled","spawn","spawn-current","switch-trigger","switch-off"].includes(l)||(i?(++Te,_e=!0,We(Fe,we,i)):et("wall"),!1)}(n,l,e,t)&&(Te<o&&(xe=!0,Qe=Fe,je=we,ze=n,Xe=l,De=0),Te=r(Te+1,o))}function Re(e=null,t=null){Ge=!0,Pe=Fe,Je=we,Ie=e||pe,Se=t||Be,He=performance.now()}function Ue(e){Le=e,ve=Ve(Le)}function Ve(e){switch(e){case u:return 2;case g:case Z:return 1;case d:return 0}}function We(e,M,r){const n=ae(e,M,["trap","switch-trigger"]),l=ae(Fe,we);switch(n?.tile){case"trap":r||"hole"===l?.tile||(et("trap"),n.tile="hole");break;case"switch-trigger":qe()}switch(l?.tile){case"hole":case"spikes":Re(e,M),--Te;break;case"flag":return t("currentLevel",G+1),le(G+1),!1;case"spawn-current":Te=0;break;case"spawn":ae(pe,Be).tile="spawn",l.tile="spawn-current",l.animationFrame=0,l.elapsed=0,pe=Fe,Be=we,Te=0;break;case"switch-trigger":qe();break;case"key":ce("key",Fe,we),et("key"),++O}Te>=o&&(Re(),setTimeout((()=>{Te=0}),h))}function $e(e){!function(e){if(A[G].levelData.forEach((t=>{if(i[t.tile].tiles.length>1){t.elapsed=(t.elapsed||0)+e;const M=Y[t.tile];t.elapsed>=M&&(t.animationFrame=(t.animationFrame+1)%i[t.tile].tiles.length||0,t.elapsed=0)}if(t.isBeingRemoved){t.elapsed=(t.elapsed||0)+e;const M=t.removalDuration||N;t.scale=n(1-t.elapsed/M,0),t.scale<=0&&(ce(t.tile,t.x,t.y),t.removeCallback&&t.removeCallback())}})),!xe&&!Ge&&D.length>0){switch(D[D.length-1]){case"up":Ke(0,-1,u);break;case"down":Ke(0,1,d);break;case"left":Ke(-1,0,Z);break;case"right":Ke(1,0,g)}}xe&&function(e){De+=e;const t=r(De/q,1);Fe=Qe+(ze-Qe)*t,we=je+(Xe-je)*t;let M=Ve(Le);switch(Math.floor(3*t)){case 0:ve=M+3;break;case 1:ve=M;break;case 2:ve=M+6}t>=1&&(xe=!1,Fe=ze,we=Xe,De=0,ve=M,We(Qe,je))}(e);be&&function(e){me+=e;const t=Math.abs(ge-Ze)+Math.abs(de-Ae);const M=r(me/(f*t),1);if("boulder"===be.tile){const e=4,r=t*e,n=Math.floor(M*r)%e;be.o=n}be.x=ge+(Ze-ge)*M,be.y=de+(Ae-de)*M,M>=1&&(be.x=Ze,be.y=Ae,me=0,"crate"===be.tile&&function(e){const t=ae(e.x,e.y,["hole","trap"]);t&&(ce(t.tile,e.x,e.y),ce("crate",e.x,e.y),se("hole-filled",e.x,e.y,{isUnder:!0}),et("fall"))}(be),["crate","boulder"].includes(be.tile)&&ae(be.x,be.y,["switch-trigger"])&&qe(),be=null)}(e)}(e-v),Ge&&function(){const e=performance.now()-He,t=r(e/h,1);t<.5?(Ee=1-2*t,Fe=Pe,we=Je):(Ee=2*(t-.5),Fe=Ie,we=Se,Ie===pe&&Se===Be&&Ue(d));t>=1&&(Ge=!1,Fe=Ie,we=Se,Ee=1)}(),ee(),v=e,requestAnimationFrame($e)}addEventListener("keydown",(e=>{const t=Oe(e.key);"game"===y&&function(e){e&&!D.includes(e)&&D.push(e)}(t),"menu"===y&&function(e,t){switch(e){case"up":ct=(ct-1+ot.length)%ot.length,ot[ct].isDisabled&&(ct=(ct-1+ot.length)%ot.length);break;case"down":ct=(ct+1)%ot.length,ot[ct].isDisabled&&(ct=(ct+1)%ot.length)}if("Enter"===t.key){const e=ot[ct];e.isDisabled||ft(e.action)}}(t,e),"Escape"===e.key&&it("menu")})),addEventListener("keyup",(e=>{const t=Oe(e.key);"game"===y&&ke(t)})),w.addEventListener("mousemove",(e=>{e.preventDefault();const t=w.getBoundingClientRect(),M=e.clientX-t.left,r=e.clientY-t.top;"menu"===y&&Nt.forEach(((e,t)=>{M>=e.x&&M<=e.x+e.width&&r>=e.y&&r<=e.y+e.height&&(e.isDisabled||(ct=t))})),"editor"===y&&(J.x=Math.floor(M/(a*k)),J.y=Math.floor(r/(a*k)),Mt(),tt&&rt(e))})),w.addEventListener("mouseleave",(e=>{e.preventDefault(),"editor"===y&&(J.x=-1,J.y=-1,Mt())})),w.addEventListener("mousewheel",(e=>{if(e.preventDefault(),"editor"===y){const t=n(-1,r(1,e.wheelDelta||-e.detail));P.value=(parseInt(P.value)+t+4)%4,Mt()}})),w.addEventListener("mousedown",(e=>{tt=!0,"editor"===y&&rt(e)})),w.addEventListener("click",(e=>{"menu"===y&&function(e){const t=w.getBoundingClientRect(),M=e.clientX-t.left,r=e.clientY-t.top;Nt.forEach((e=>{M>=e.x&&M<=e.x+e.width&&r>=e.y&&r<=e.y+e.height&&(e.isDisabled||ft(e.action))}))}(e)})),window.addEventListener("mouseup",(e=>{tt=!1}));let _e=!1;function et(e){switch(e){case"gong-trigger":I(...[,0,523.2511,.02,,1.5,1,.5,-.05,.5,,,.3,.05,,,.05,.8,,.05]);break;case"block":I(...[,0,146.8324,.1,,0,,,,,,,,4,,,,0,.2]);break;case"boulder":I(...[,0,73.41619,.1,,0,,,,,,,,4,,,,0,.2]);break;case"crate":I(...[,0,146.8324,.05,,.05,,1.3,,,,,,3]);break;case"key":I(...[,0,1320,,.06,.3,1,,,,880,.06]);break;case"lock":I(...[,0,440,.1,,,1,.3,,,-110,.15,,,,,,,.1]);break;case"trap":I(...[.5,0,440,.08,,.2,4,2,,,,,,5]);break;case"wall":_e||(_e=!0,I(...[,0,440,.15,.01,.12,1,1.59,-6.98,4.97]))}}let tt=!1;function Mt(){const e=H.value,t=parseInt(P.value);ne(i[e].tiles[0],i[e].co,J.x,J.y,{o:i[e].cCO?t:u,scale:1,flipHorizontally:!1,alpha:.5})}function rt(e){if(1===e.buttons){if(!ae(J.x,J.y)&&ie(J.x,J.y)){se(H.value,J.x,J.y,{o:i[H.value].cCO?parseInt(P.value):u});W(A[G].levelData)}}else if(2===e.buttons){ce(H.value,J.x,J.y);W(A[G].levelData)}}e("#editorTestLevelButton").addEventListener("click",(()=>{if(!function(){let e=A[G].levelData,t=0,M=0;e.forEach((e=>{"spawn-current"===e.tile?t++:"flag"===e.tile&&M++}));let r="",n=1===t&&1===M;n||(1!==t&&(r+="There must be exactly one player spawn point.\n"),1!==M&&(r+="There must be exactly one flag.\n"));return nt.textContent=r,n}())return;let e=W(A[G].levelData);window.open(`./index.html?level=${e}`)}));let nt=e("#editorMessage");function lt(){k=Math.min(Math.floor(window.innerWidth/(c*a)),Math.floor(.89*window.innerHeight/(s*a))),w.width=c*a*k,w.height=s*a*k,B.width=w.width,B.height=1.1*a*k,window.innerWidth/window.innerHeight>c/s?(b.width=window.innerWidth,b.height=window.innerWidth*(s/c)):(b.height=window.innerHeight,b.width=window.innerHeight*(c/s))}function it(e){document.body.classList.remove(y),document.body.classList.add(e),y=e,"game"===y&&le(G),"editor"===y&&(G=0,le(G),Object.keys(i).forEach((e=>{if(0!==i[e].limit){let t=document.createElement("option");t.value=e,t.text=e,H.appendChild(t)}})))}window.addEventListener("resize",(()=>{lt(),Me("s","rock")})),function(){x.imageSmoothingEnabled=!1,lt();const e=new URLSearchParams(window.location.search).get("level");if(e){let t=R(e);t&&(A.push(t),G=A.length-1,it("game"))}else it(y);requestAnimationFrame($e)}();let at=null!==M("currentLevel");const ot=[{text:"CONTINUE",action:"continue",isDisabled:!at},{text:"NEW GAME",action:"newGame",isDisabled:!1},{text:"LEVEL EDITOR",action:"levelEditor",isDisabled:!1}];let ct=at?0:1,st=.6,Yt=1,Nt=[];function ft(e){switch(e){case"continue":G=parseInt(M("currentLevel")),it("game");break;case"newGame":it("game");break;case"levelEditor":it("editor")}}const qt=[[-.5,0,-.375,.125],[.25,-.25,.375,-.125],[-.3125,.1875,-.4375,.0625],[.4375,-.0625,.3125,-.1875]],ht=4;function ut(e,t,M,r,n,l,i=.25){for(let a=0;a<r;a++){const o=a*k/r;for(let r=0;r<t;r++){const t=o+qt[a%ht][r%ht]*i<.5?n:l;e.fillStyle=t,e.fillRect(r*k,M+a*k,k,k)}}}}();</script></div></body></html>